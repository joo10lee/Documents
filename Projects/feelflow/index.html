<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <meta name="apple-mobile-web-app-title" content="FeelFlow">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/api.js"></script>  
    <script src="js/ui.js"></script>
    <script src="js/activities.js"></script> <script src="js/tracker.js"></script> 
    <script src="js/app.js"></script>
    <script>
        // 1. ì•± ì´ˆê¸° ì‹¤í–‰ (ëª¨ë“  JS íŒŒì¼ì´ ë¡œë“œëœ í›„ ì‹¤í–‰)
        window.onload = function() {
            console.log("FeelFlow ì¸í”„ë¼ ë¡œë“œ ì™„ë£Œ.");

            // ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ (PWA ê¸°ëŠ¥)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW fail:', err));
            }

            // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
            if ("Notification" in window && Notification.permission !== "granted") {
                Notification.requestPermission();
            }

            // app.jsì˜ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
            if (typeof initApp === 'function') {
                initApp();
            }
        };
    </script>  
   
    <title>FeelFlow - Emotion Regulation Helper</title>
    
</head>
<body>
    <!-- Weather Header -->
    <div class="weather-header" id="weatherHeader">
        <div class="weather-top">
            <div>
                <div class="weather-date" id="weatherDate">Loading...</div>
                <div class="weather-day" id="weatherDay">...</div>
            </div>
            <div class="weather-info">
                <div>
                    <div class="weather-temp" id="weatherTemp">--Â°</div>
                    <div class="weather-desc" id="weatherDesc">--</div>
                </div>
                <div class="weather-icon" id="weatherIcon">ğŸŒ¤ï¸</div>
            </div>
        </div>
        <div class="weather-tip">
            <span class="weather-tip-icon">ğŸ¤–</span>
            <span id="weatherTipText">Set your location in Settings to see weather tips!</span>
        </div>
    </div>

    <header class="header" style="position: relative;"> <span id="build-version" style="
        position: absolute; 
        top: 10px; 
        right: 15px; 
        color: #a0aec0; 
        font-size: 0.65rem; 
        font-family: monospace;
        z-index: 100;
    ">Ver.0213-0118</span>

    <p class="app-title">FEELFLOW</p>
    <p class="greeting" id="greeting">Good evening, Joo!</p>
    <h1 class="question" id="screenTitle"></h1>
</header>

    <!-- SCREEN 1: Emotion Selection -->
    <main class="screen active" id="screen1">
        <div id="streakBanner"></div>
        <div class="emotion-container">
            <button class="emotion-btn happy" onclick="selectEmotion('Happy', 'ğŸ˜Š', '#fcd34d')">
                <span class="emoji">ğŸ˜Š</span>
                <span class="emotion-text">Happy</span>
            </button>
            <button class="emotion-btn sad" onclick="selectEmotion('Sad', 'ğŸ˜¢', '#93c5fd')">
                <span class="emoji">ğŸ˜¢</span>
                <span class="emotion-text">Sad</span>
            </button>
            <button class="emotion-btn anxious" onclick="selectEmotion('Anxious', 'ğŸ˜°', '#c4b5fd')">
                <span class="emoji">ğŸ˜°</span>
                <span class="emotion-text">Anxious</span>
            </button>
            <button class="emotion-btn angry" onclick="selectEmotion('Angry', 'ğŸ˜ ', '#fca5a5')">
                <span class="emoji">ğŸ˜ </span>
                <span class="emotion-text">Angry</span>
            </button>
            <button class="emotion-btn calm" onclick="selectEmotion('Calm', 'ğŸ˜Œ', '#6ee7b7')">
                <span class="emoji">ğŸ˜Œ</span>
                <span class="emotion-text">Calm</span>
            </button>
            <button class="emotion-btn tired" onclick="selectEmotion('Tired', 'ğŸ˜«', '#9ca3af')">
                <span class="emoji">ğŸ˜«</span>
                <span class="emotion-text">Tired</span>
            </button>
        </div>
        <p class="hint">Tap how you're feeling</p>
    </main>

    <!-- SCREEN 2: Intensity -->
    <main class="screen" id="screen2">
        <div class="selected-emotion-display" id="selectedEmoji">ğŸ˜Š</div>
        <div class="selected-emotion-name" id="selectedName">Happy</div>
        <p class="intensity-question">How strong is this feeling?</p>
        <div class="thermometer-container">
            <div class="intensity-display" id="intensityDisplay">5</div>
            <input type="range" min="1" max="10" value="5" class="intensity-slider" id="intensitySlider" oninput="updateIntensity(this.value)">
            <div class="slider-labels"><span>1 - Mild</span><span>10 - Very Strong</span></div>
        </div>
        <div class="note-container" style="margin-top: 25px; width: 100%; max-width: 400px; text-align: left;">
            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #4a5568; font-size: 0.95rem;">
                What's on your mind? (Optional)
            </label>
            <textarea id="emotionNote" 
                      placeholder="e.g. Finished my homework! ğŸ“š" 
                      style="width: 100%; height: 90px; padding: 15px; border-radius: 15px; border: 2px solid #e2e8f0; font-family: inherit; font-size: 1rem; resize: none; outline: none; transition: border-color 0.2s;"
                      onfocus="this.style.borderColor='#7c3aed'"
                      onblur="this.style.borderColor='#e2e8f0'"></textarea>
        </div>
        <button class="btn btn-primary" onclick="goToResult()">Next</button>
        <button class="btn btn-secondary" onclick="goToScreen(1, 'How are you feeling today?')">â† Back</button>
    </main>

    <!-- SCREEN 3: Result -->
    <main class="screen" id="screen3">
        <div class="result-card">
            <div class="result-emoji" id="resultEmoji">ğŸ˜Š</div>
            <p class="result-text">You're feeling</p>
            <div class="result-intensity" id="resultText">Happy at level 5</div>
            <p class="result-text">Let's find some helpful strategies!</p>
        </div>
        <button class="btn btn-primary" onclick="goToStrategies()" style="margin-top: 30px;">See Strategies</button>
        <button class="btn btn-secondary" onclick="goToScreen(2, 'How strong is it?')">â† Back</button>
    </main>

    <!-- SCREEN 4: Strategies -->
    <main class="screen" id="screen4">
        <div class="strategies-intro">
            <div class="strategies-emoji" id="strategiesEmoji">ğŸ˜°</div>
            <p class="strategies-subtitle">Tap a strategy to try it:</p>
        </div>
        <div class="strategies-container" id="strategiesContainer"></div>
        <div class="strategies-footer">
            <button class="btn btn-primary" onclick="finishCheckIn()">Done</button>
            <button class="btn btn-secondary" onclick="goToScreen(3, 'Check-in Complete!')">â† Back</button>
        </div>
    </main>

    <!-- SCREEN 5: Final -->
    <main class="screen" id="screen5">
        <div class="result-card">
            <div class="result-emoji">âœ¨</div>
            <p class="result-text" style="font-size: 1.4rem; font-weight: 600; margin-bottom: 16px;">Great job checking in!</p>
            <p class="result-text" id="finalMessage">Remember: It's okay to feel any emotion.</p>
        </div>
        <button class="btn btn-primary" onclick="startOver()" style="margin-top: 30px;">Check in again</button>
    </main>

    <!-- SCREEN: History -->
    <main class="screen" id="screenHistory">
        <div class="history-container">
            <div class="chart-container" style="position: relative; height: 220px; width: 100%; background: white; border-radius: 20px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 24px;">
                <div style="font-size: 0.9rem; font-weight: 600; color: #2d3748; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">ğŸ“ˆ 7-Day Emotion Trend</div>
                <canvas id="emotionChart"></canvas>
            </div>
            <div class="stats-grid" id="statsGrid"></div>
            <div class="history-section-title">ğŸ“… Recent Check-ins</div>
            <div class="history-list" id="historyList"></div>
            <button class="btn btn-danger btn-small clear-history-btn" onclick="clearHistory()">Clear All History</button>
        </div>
    </main>

    <!-- SCREEN: Tracker -->
    <main class="screen" id="screenTracker">
        <div class="tracker-container">
            <!-- Tabs -->
            <div class="tracker-tabs">
                <button class="tracker-tab active" id="tabMorning" onclick="switchRoutine('morning')">
                    <span class="tab-icon">ğŸŒ…</span> Morning
                </button>
                <button class="tracker-tab" id="tabEvening" onclick="switchRoutine('evening')">
                    <span class="tab-icon">ğŸŒ™</span> Evening
                </button>
            </div>

            <!-- Sticker Reward (shown when complete) -->
            <div class="sticker-reward" id="stickerReward" style="display: none;">
                <div class="sticker-reward-icon">â­</div>
                <div class="sticker-reward-text">Amazing! You earned a sticker!</div>
                <div class="sticker-reward-sub">All tasks completed</div>
            </div>

            <!-- Progress -->
            <div class="progress-card">
                <div class="progress-header">
                    <span class="progress-title" id="progressTitle">Morning Routine</span>
                    <span class="progress-fraction" id="progressFraction">0/0</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
                </div>
                <div class="progress-message" id="progressMessage">Let's get started!</div>
            </div>

            <!-- Task List -->
            <div class="task-list" id="taskList"></div>

            <!-- Add Task -->
            <div class="add-task-container">
                <input type="text" class="add-task-input" id="addTaskInput" placeholder="Add a new task..." onkeypress="handleTaskKeypress(event)">
                <button class="add-task-btn" onclick="addCustomTask()">+</button>
            </div>

            <!-- Sticker Collection -->
            <div class="sticker-collection">
                <div class="sticker-collection-title">ğŸ† This Week's Stickers</div>
                <div class="sticker-grid" id="stickerGrid"></div>
            </div>

            <!-- Weekly Stats -->
            <div class="weekly-stats">
                <div class="weekly-stats-title">ğŸ“Š Weekly Progress</div>
                <div class="weekly-days" id="weeklyDays"></div>
            </div>
        </div>
    </main>

    <!-- Breathing Screen -->
    <main class="screen" id="screenBreathing">
        <div class="breathing-container">
            <div class="pattern-selector">
                <button class="pattern-btn active" onclick="selectPattern('relaxing')">Relaxing (4-7-8)</button>
                <button class="pattern-btn" onclick="selectPattern('box')">Box Breathing</button>
                <button class="pattern-btn" onclick="selectPattern('quick')">Quick Calm</button>
            </div>
            <div class="breathing-circle-container">
                <div class="breathing-circle" id="breathingCircle"><span class="breathing-icon">ğŸ«</span></div>
            </div>
            <div class="breathing-instruction" id="breathingInstruction">Press Start</div>
            <div class="breathing-counter" id="breathingCounter"></div>
            <div class="breathing-progress" id="breathingProgress">5 breaths remaining</div>
            <div class="breathing-buttons">
                <button class="btn btn-primary btn-small" id="breathingStartBtn" onclick="toggleBreathing()">Start</button>
                <button class="btn btn-secondary btn-small" onclick="backToStrategies()">â† Back</button>
            </div>
        </div>
    </main>

    <!-- Grounding Screen -->
    <main class="screen" id="screenGrounding">
        <div class="grounding-progress-bar">
            <div class="progress-dot active" id="dot1"></div>
            <div class="progress-dot" id="dot2"></div>
            <div class="progress-dot" id="dot3"></div>
            <div class="progress-dot" id="dot4"></div>
            <div class="progress-dot" id="dot5"></div>
        </div>
        <div class="grounding-container" id="groundingContainer">
            <div class="grounding-step active" id="groundingStep1">
                <div class="grounding-number">5</div>
                <div class="grounding-sense">ğŸ‘€ Things You SEE</div>
                <div class="grounding-prompt">Look around. Name 5 things you can see.</div>
                <div class="grounding-inputs">
                    <input type="text" class="grounding-input" placeholder="1. I see..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="2. I see..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="3. I see..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="4. I see..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="5. I see..." oninput="checkGroundingInput(this)">
                </div>
            </div>
            <div class="grounding-step" id="groundingStep2">
                <div class="grounding-number">4</div>
                <div class="grounding-sense">âœ‹ Things You TOUCH</div>
                <div class="grounding-prompt">Notice 4 things you can physically feel.</div>
                <div class="grounding-inputs">
                    <input type="text" class="grounding-input" placeholder="1. I feel..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="2. I feel..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="3. I feel..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="4. I feel..." oninput="checkGroundingInput(this)">
                </div>
            </div>
            <div class="grounding-step" id="groundingStep3">
                <div class="grounding-number">3</div>
                <div class="grounding-sense">ğŸ‘‚ Things You HEAR</div>
                <div class="grounding-prompt">Name 3 sounds you hear.</div>
                <div class="grounding-inputs">
                    <input type="text" class="grounding-input" placeholder="1. I hear..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="2. I hear..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="3. I hear..." oninput="checkGroundingInput(this)">
                </div>
            </div>
            <div class="grounding-step" id="groundingStep4">
                <div class="grounding-number">2</div>
                <div class="grounding-sense">ğŸ‘ƒ Things You SMELL</div>
                <div class="grounding-prompt">Notice 2 things you can smell.</div>
                <div class="grounding-inputs">
                    <input type="text" class="grounding-input" placeholder="1. I smell..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="2. I smell..." oninput="checkGroundingInput(this)">
                </div>
            </div>
            <div class="grounding-step" id="groundingStep5">
                <div class="grounding-number">1</div>
                <div class="grounding-sense">ğŸ‘… Thing You TASTE</div>
                <div class="grounding-prompt">Notice 1 thing you can taste.</div>
                <div class="grounding-inputs">
                    <input type="text" class="grounding-input" placeholder="1. I taste..." oninput="checkGroundingInput(this)">
                </div>
            </div>
        </div>
        <button class="btn btn-primary" id="groundingNextBtn" onclick="nextGroundingStep()">Next</button>
        <button class="btn btn-secondary" onclick="backToStrategies()">â† Back</button>
    </main>

    <!-- Squeeze Screen -->
    <main class="screen" id="screenSqueeze">
        <div class="squeeze-container">
            <div class="squeeze-visual" id="squeezeVisual">âœŠ</div>
            <div class="squeeze-instruction" id="squeezeInstruction">Press Start when ready</div>
            <div class="squeeze-counter" id="squeezeCounter"></div>
            <div class="squeeze-round" id="squeezeRound">3 rounds total</div>
            <div class="breathing-buttons">
                <button class="btn btn-primary btn-small" id="squeezeStartBtn" onclick="toggleSqueeze()">Start</button>
                <button class="btn btn-secondary btn-small" onclick="backToStrategies()">â† Back</button>
            </div>
        </div>
    </main>

    <!-- Activity Screen -->
    <main class="screen" id="screenActivity">
        <div class="activity-container">
            <div class="activity-card">
                <div class="activity-icon" id="activityIcon">ğŸ§¸</div>
                <div class="activity-title" id="activityTitle">Comfort Object</div>
                <div class="activity-steps" id="activitySteps"></div>
                <div class="activity-timer" id="activityTimer"></div>
    
                <div id="inAppActionArea" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; display: none;">
                    <p style="font-weight: 600; color: #4a5568; margin-bottom: 10px;" id="actionQuestion">ğŸ§¸ What brings you comfort right now?</p>
                    <textarea id="actionNote" placeholder="ê¸°ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”..." 
                           style="width: 100%; height: 60px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 15px; font-family: inherit; resize: none; outline: none;"></textarea>
                    
                    <div id="photoPreviewContainer" style="display: none; margin-bottom: 15px;">
                        <img id="capturedPhoto" src="" style="width: 100%; border-radius: 12px; border: 2px solid #7c3aed;">
                        <button onclick="EmotionActions.reset()" style="background: none; border: none; color: #ef4444; font-size: 0.8rem; margin-top: 5px; cursor: pointer;">âœ• ì‚¬ì§„ ë‹¤ì‹œ ì°ê¸°</button>
                    </div>
                
                    <button onclick="EmotionActions.startCamera()" id="cameraBtn" class="btn-secondary" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px;">ğŸ“¸ ì‚¬ì§„ ì°ê¸°</button>
                    
                    <div id="videoContainer" style="display: none; margin-top: 10px;">
                        <video id="videoElement" width="100%" autoplay playsinline style="border-radius: 12px; background: #000;"></video>
                        <button onclick="EmotionActions.takePhoto()" class="btn-primary" style="width: 100%; margin-top: 10px;">ğŸ“· Take a photo! </button>
                        <canvas id="hiddenCanvas" style="display: none;"></canvas>
                    </div>
                </div>
            </div> <button class="btn btn-primary" id="activityBtn" onclick="finishCheckIn()">Save & Finish</button>
            <button class="btn btn-secondary" onclick="backToStrategies()">â† Back</button>
        </div> </main>
        
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-btn active" id="navHome" onclick="goHome()">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-label">Home</span>
        </button>
        <button class="nav-btn" id="navTracker" onclick="goToTracker()">
            <span class="nav-icon">âœ…</span>
            <span class="nav-label">Tracker</span>
        </button>
        <button class="nav-btn" id="navHistory" onclick="goToHistory()">
            <span class="nav-icon">ğŸ“…</span>
            <span class="nav-label">History</span>
        </button>
        <button class="nav-btn" id="navSettings" onclick="goToSettings()">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-label">Settings</span>
        </button>
    </nav>

    <!-- SCREEN: Settings -->
    <main class="screen" id="screenSettings">
        <div class="settings-container">
            <div class="settings-section">
                <div class="settings-avatar">ğŸ‘¤</div>
                <div class="settings-section-title">ğŸ‘¤ Profile</div>
                <div class="settings-field">
                    <label class="settings-label">Your Name</label>
                    <input type="text" class="settings-input" id="settingsName" placeholder="Enter your name" oninput="saveSettings()">
                </div>
                <div class="settings-field">
                    <label class="settings-label">Your Age</label>
                    <input type="number" class="settings-input" id="settingsAge" placeholder="Enter your age" min="1" max="120" oninput="saveSettings()">
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">ğŸŒ¤ï¸ Weather Location</div>
                <div class="settings-field">
                    <button class="settings-location-btn" onclick="requestLocation()">ğŸ“ Use My Current Location</button>
                    <div class="location-status" id="locationStatus">Location not set</div>
                </div>
                <div class="settings-field">
                    <label class="settings-label">Or enter your city</label>
                    <input type="text" class="settings-input" id="settingsCity" placeholder="e.g. San Francisco, Seoul" oninput="saveSettings()">
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">ğŸ—‘ï¸ Data Management</div>
                <button class="btn btn-danger btn-small" onclick="clearAllData()" style="width:100%">Reset All Data</button>
            </div>
            <div class="settings-saved" id="settingsSaved">âœ“ Settings saved!</div>
        </div>
    </main>

   
    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-content">
            <div class="modal-icon">ğŸ—‘ï¸</div>
            <div class="modal-title">Delete Task?</div>
            <div class="modal-text">Are you sure you want to remove this task?</div>
            <div class="modal-buttons">
                <button class="btn btn-secondary btn-small" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger btn-small" onclick="confirmDeleteTask()">Delete</button>
            </div>
        </div>
    </div>

    
</body>
</html>
