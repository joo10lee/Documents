<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    
    <script>
        // ngrok Ï£ºÏÜåÎ•º Ïó¨Í∏∞Ïóê ÎÑ£ÏúºÏÑ∏Ïöî. (ÎßàÏßÄÎßâÏóê /apiÎäî ÎπºÍ≥† ÎÑ£Îäî Í≤ÉÏù¥ Î≤îÏö©ÏÑ±Ïù¥ Ï¢ãÏäµÎãàÎã§.)
        const API_BASE_URL = 'https://ungainable-sonja-bewailingly.ngrok-free.dev/api';
        
        console.log("Backend API Base URL initialized: ", API_BASE_URL);
    </script>
    
    <title>FeelFlow - Emotion Regulation Helper</title>
    <style>
        /* Basic reset and settings */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 20px;
            padding-bottom: 100px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .app-title {
            font-size: 1.2rem;
            color: #7c8a9a;
            margin-bottom: 12px;
            letter-spacing: 2px;
        }

        .greeting {
            font-size: 1.3rem;
            color: #7c8a9a;
            margin-bottom: 8px;
        }

        .question {
            font-size: 1.8rem;
            color: #2d3748;
            font-weight: 600;
        }

        /* Weather Header */
        .weather-header {
            width: 100%;
            max-width: 500px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 20px;
            padding: 20px 24px;
            margin-bottom: 24px;
            color: white;
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4);
        }

        .weather-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .weather-date { font-size: 0.9rem; opacity: 0.9; }
        .weather-day { font-size: 1.4rem; font-weight: 700; margin-top: 4px; }
        .weather-info { display: flex; align-items: center; gap: 12px; text-align: right; }
        .weather-icon { font-size: 2.5rem; }
        .weather-temp { font-size: 2rem; font-weight: 700; }
        .weather-desc { font-size: 0.85rem; opacity: 0.9; }

        .weather-tip {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 0.9rem;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            line-height: 1.4;
        }

        .weather-tip-icon { font-size: 1.3rem; flex-shrink: 0; }

        /* Settings */
        .settings-container { width: 100%; max-width: 400px; }

        .settings-section {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .settings-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #7c8a9a;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .settings-field { margin-bottom: 20px; }
        .settings-field:last-child { margin-bottom: 0; }

        .settings-label {
            display: block;
            font-size: 0.95rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .settings-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .settings-input:focus { outline: none; border-color: #7c3aed; }

        .settings-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 20px;
        }

        .settings-location-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 16px;
            background: #f3f4f6;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            color: #4a5568;
            cursor: pointer;
            width: 100%;
            justify-content: center;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .settings-location-btn:hover { background: #e2e8f0; border-color: #7c3aed; }

        .location-status {
            font-size: 0.85rem;
            color: #7c8a9a;
            margin-top: 10px;
            text-align: center;
        }

        .location-status.success { color: #10b981; }
        .location-status.error { color: #ef4444; }

        .settings-saved {
            background: #d1fae5;
            color: #065f46;
            padding: 12px 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            margin-top: 20px;
            display: none;
        }

        .settings-saved.show { display: block; animation: fadeInSaved 0.3s ease; }

        @keyframes fadeInSaved {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Screen containers */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 500px;
        }

        .screen.active {
            display: flex;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: center;
            gap: 0;
            padding: 12px 20px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .nav-btn {
            flex: 1;
            max-width: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            color: #7c8a9a;
            transition: all 0.2s ease;
        }

        .nav-btn:hover, .nav-btn.active {
            color: #7c3aed;
        }

        .nav-btn .nav-icon {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .nav-btn .nav-label {
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* ===== EMOTION SCREENS STYLES ===== */
        .emotion-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            width: 100%;
            max-width: 400px;
        }

        .emotion-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px 16px;
            border: 3px solid transparent;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 120px;
        }

        .emotion-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .emoji {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .emotion-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
        }

        .happy { background-color: #fef3c7; border-color: #fcd34d; }
        .happy:hover { background-color: #fde68a; }
        .sad { background-color: #dbeafe; border-color: #93c5fd; }
        .sad:hover { background-color: #bfdbfe; }
        .anxious { background-color: #ede9fe; border-color: #c4b5fd; }
        .anxious:hover { background-color: #ddd6fe; }
        .angry { background-color: #fee2e2; border-color: #fca5a5; }
        .angry:hover { background-color: #fecaca; }
        .calm { background-color: #d1fae5; border-color: #6ee7b7; }
        .calm:hover { background-color: #a7f3d0; }
        .tired { background-color: #e5e7eb; border-color: #9ca3af; }
        .tired:hover { background-color: #d1d5db; }

        .hint {
            margin-top: 40px;
            color: #7c8a9a;
            font-size: 0.95rem;
        }

        /* Thermometer */
        .selected-emotion-display { font-size: 5rem; margin-bottom: 16px; }
        .selected-emotion-name { font-size: 1.5rem; color: #2d3748; font-weight: 600; margin-bottom: 40px; }
        .intensity-question { font-size: 1.3rem; color: #4a5568; margin-bottom: 30px; text-align: center; }

        .thermometer-container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .intensity-display {
            font-size: 4rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
            transition: color 0.3s ease;
        }

        .intensity-slider {
            width: 100%;
            height: 60px;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }

        .intensity-slider::-webkit-slider-runnable-track {
            height: 24px;
            border-radius: 12px;
            background: linear-gradient(to right, #e2e8f0, #cbd5e1);
        }

        .intensity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #4a5568;
            border: 4px solid white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            margin-top: -12px;
        }

        .intensity-slider::-moz-range-track {
            height: 24px;
            border-radius: 12px;
            background: linear-gradient(to right, #e2e8f0, #cbd5e1);
        }

        .intensity-slider::-moz-range-thumb {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #4a5568;
            border: 4px solid white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            color: #7c8a9a;
            font-size: 0.9rem;
        }

        /* Buttons */
        .btn {
            padding: 16px 48px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background-color: #4a5568;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2d3748;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary {
            background-color: transparent;
            color: #7c8a9a;
            margin-top: 16px;
        }

        .btn-secondary:hover {
            color: #4a5568;
        }

        .btn-small {
            padding: 12px 24px;
            font-size: 1rem;
        }

        .btn-danger {
            background-color: #fee2e2;
            color: #dc2626;
        }

        .btn-danger:hover {
            background-color: #fecaca;
        }

        /* Result cards */
        .result-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .result-emoji { font-size: 4rem; margin-bottom: 16px; }
        .result-text { font-size: 1.2rem; color: #4a5568; line-height: 1.6; }
        .result-intensity { font-size: 1.8rem; font-weight: 700; margin: 20px 0; }

        /* Strategies */
        .strategies-intro { text-align: center; margin-bottom: 30px; }
        .strategies-emoji { font-size: 3rem; margin-bottom: 10px; }
        .strategies-subtitle { color: #7c8a9a; font-size: 1rem; }

        .strategies-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            max-width: 400px;
        }

        .strategy-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: flex-start;
            gap: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .strategy-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
            border-color: #e2e8f0;
        }

        .strategy-card.has-detail:hover { border-color: #c4b5fd; }
        .strategy-icon { font-size: 2.5rem; flex-shrink: 0; }
        .strategy-content { flex: 1; }
        .strategy-title { font-size: 1.1rem; font-weight: 600; color: #2d3748; margin-bottom: 6px; }
        .strategy-description { font-size: 0.95rem; color: #7c8a9a; line-height: 1.5; }

        .strategy-badge {
            background-color: #ede9fe;
            color: #7c3aed;
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 20px;
            font-weight: 600;
            margin-top: 8px;
            display: inline-block;
        }

        .strategies-footer { margin-top: 30px; text-align: center; }

        /* History */
        .history-container { width: 100%; max-width: 400px; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .stat-value { font-size: 2.5rem; font-weight: 700; color: #7c3aed; }
        .stat-label { font-size: 0.85rem; color: #7c8a9a; margin-top: 4px; }
        .stat-card.wide { grid-column: span 2; }

        .top-emotion { display: flex; align-items: center; justify-content: center; gap: 12px; }
        .top-emotion-emoji { font-size: 2.5rem; }
        .top-emotion-name { font-size: 1.5rem; font-weight: 600; color: #2d3748; }

        .history-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 16px;
        }

        .history-list { display: flex; flex-direction: column; gap: 12px; }

        .history-item {
            background: white;
            border-radius: 16px;
            padding: 16px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .history-emoji { font-size: 2rem; }
        .history-details { flex: 1; }
        .history-emotion { font-size: 1rem; font-weight: 600; color: #2d3748; }
        .history-meta { font-size: 0.85rem; color: #7c8a9a; margin-top: 2px; }

        .history-level {
            background: #f3f4f6;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #4a5568;
        }

        .history-date-group { margin-bottom: 24px; }

        .history-date-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #7c8a9a;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .empty-history { text-align: center; padding: 60px 20px; color: #7c8a9a; }
        .empty-history-icon { font-size: 4rem; margin-bottom: 16px; }
        .empty-history-text { font-size: 1.1rem; }
        .clear-history-btn { margin-top: 30px; }

        /* Streak banner */
        .streak-banner {
            background: linear-gradient(135deg, #fcd34d, #f59e0b);
            color: #78350f;
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
        }

        /* ===== TRACKER STYLES ===== */
        .tracker-container {
            width: 100%;
            max-width: 400px;
        }

        .tracker-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
        }

        .tracker-tab {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            font-size: 1rem;
            font-weight: 600;
            color: #7c8a9a;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tracker-tab:hover {
            border-color: #c4b5fd;
        }

        .tracker-tab.active {
            background: #7c3aed;
            border-color: #7c3aed;
            color: white;
        }

        .tracker-tab .tab-icon {
            font-size: 1.2rem;
        }

        /* Progress card */
        .progress-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .progress-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
        }

        .progress-fraction {
            font-size: 1rem;
            font-weight: 600;
            color: #7c3aed;
        }

        .progress-bar-container {
            height: 16px;
            background: #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #7c3aed, #a78bfa);
            border-radius: 8px;
            transition: width 0.5s ease;
        }

        .progress-message {
            margin-top: 12px;
            font-size: 0.9rem;
            color: #7c8a9a;
            text-align: center;
        }

        /* Task list */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .task-item {
            background: white;
            border-radius: 16px;
            padding: 16px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .task-item:hover {
            border-color: #e2e8f0;
        }

        .task-item.completed {
            background: #f0fdf4;
            border-color: #6ee7b7;
        }

        .task-checkbox {
            width: 32px;
            height: 32px;
            border: 3px solid #cbd5e1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .task-item.completed .task-checkbox {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
            color: #7c8a9a;
        }

        .task-icon {
            font-size: 1.5rem;
        }

        .task-delete {
            background: none;
            border: none;
            color: #cbd5e1;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4px;
            transition: color 0.2s ease;
        }

        .task-delete:hover {
            color: #ef4444;
        }

        /* Add task */
        .add-task-container {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .add-task-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .add-task-input:focus {
            outline: none;
            border-color: #7c3aed;
        }

        .add-task-btn {
            padding: 14px 20px;
            background: #7c3aed;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-task-btn:hover {
            background: #6d28d9;
        }

        /* Sticker reward */
        .sticker-reward {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 24px;
            animation: celebrate 0.5s ease;
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .sticker-reward-icon {
            font-size: 4rem;
            margin-bottom: 12px;
        }

        .sticker-reward-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: #78350f;
        }

        .sticker-reward-sub {
            font-size: 0.9rem;
            color: #92400e;
            margin-top: 8px;
        }

        /* Sticker collection */
        .sticker-collection {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
        }

        .sticker-collection-title {
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .sticker-slot {
            aspect-ratio: 1;
            background: #f3f4f6;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .sticker-slot.earned {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
        }

        .sticker-slot.empty {
            color: #d1d5db;
        }

        /* Weekly stats */
        .weekly-stats {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .weekly-stats-title {
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 16px;
        }

        .weekly-days {
            display: flex;
            justify-content: space-between;
        }

        .weekly-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .weekly-day-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #7c8a9a;
        }

        .weekly-day-status {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .weekly-day-status.completed {
            background: linear-gradient(135deg, #6ee7b7, #34d399);
            color: white;
        }

        .weekly-day-status.partial {
            background: linear-gradient(135deg, #fcd34d, #f59e0b);
            color: white;
        }

        .weekly-day-status.missed {
            background: #f3f4f6;
            color: #d1d5db;
        }

        .weekly-day-status.today {
            border: 3px solid #7c3aed;
        }

        /* Breathing and other exercise styles (kept from previous version) */
        .breathing-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 400px;
        }

        .pattern-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .pattern-btn {
            padding: 10px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            background: white;
            color: #4a5568;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pattern-btn:hover { border-color: #c4b5fd; }
        .pattern-btn.active { background: #7c3aed; border-color: #7c3aed; color: white; }

        .breathing-circle-container {
            position: relative;
            width: 250px;
            height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
        }

        .breathing-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #c4b5fd, #a78bfa);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 10px 40px rgba(167, 139, 250, 0.4);
        }

        .breathing-circle.inhale { animation: breatheIn 4s ease-in-out forwards; }
        .breathing-circle.hold { width: 200px; height: 200px; }
        .breathing-circle.exhale { animation: breatheOut 4s ease-in-out forwards; }

        @keyframes breatheIn {
            0% { width: 120px; height: 120px; }
            100% { width: 200px; height: 200px; }
        }

        @keyframes breatheOut {
            0% { width: 200px; height: 200px; }
            100% { width: 120px; height: 120px; }
        }

        .breathing-icon { font-size: 3rem; }
        .breathing-instruction { font-size: 1.8rem; font-weight: 600; color: #2d3748; margin-bottom: 10px; min-height: 40px; }
        .breathing-counter { font-size: 4rem; font-weight: 700; color: #7c3aed; margin-bottom: 20px; min-height: 70px; }
        .breathing-progress { font-size: 1rem; color: #7c8a9a; margin-bottom: 30px; }
        .breathing-buttons { display: flex; gap: 16px; }

        /* Grounding */
        .grounding-container { width: 100%; max-width: 400px; }

        .grounding-step {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            display: none;
        }

        .grounding-step.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .grounding-number { font-size: 3rem; font-weight: 700; color: #7c3aed; margin-bottom: 10px; }
        .grounding-sense { font-size: 1.4rem; font-weight: 600; color: #2d3748; margin-bottom: 8px; }
        .grounding-prompt { font-size: 1.1rem; color: #7c8a9a; margin-bottom: 20px; }
        .grounding-inputs { display: flex; flex-direction: column; gap: 10px; }

        .grounding-input {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .grounding-input:focus { outline: none; border-color: #c4b5fd; }
        .grounding-input.filled { border-color: #6ee7b7; background-color: #f0fdf4; }

        .grounding-progress-bar { display: flex; justify-content: center; gap: 8px; margin-bottom: 30px; }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e2e8f0;
            transition: all 0.3s ease;
        }

        .progress-dot.active { background: #7c3aed; transform: scale(1.2); }
        .progress-dot.completed { background: #6ee7b7; }

        /* Squeeze */
        .squeeze-container { text-align: center; width: 100%; max-width: 400px; }

        .squeeze-visual {
            width: 150px;
            height: 150px;
            margin: 30px auto;
            background: linear-gradient(135deg, #fca5a5, #f87171);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            transition: all 0.3s ease;
            box-shadow: 0 10px 40px rgba(248, 113, 113, 0.4);
        }

        .squeeze-visual.squeezing { transform: scale(0.8); background: linear-gradient(135deg, #f87171, #ef4444); }
        .squeeze-visual.releasing { transform: scale(1.1); background: linear-gradient(135deg, #6ee7b7, #34d399); }
        .squeeze-instruction { font-size: 1.8rem; font-weight: 600; color: #2d3748; margin-bottom: 10px; }
        .squeeze-counter { font-size: 3rem; font-weight: 700; color: #ef4444; margin-bottom: 20px; }
        .squeeze-counter.release { color: #10b981; }
        .squeeze-round { font-size: 1rem; color: #7c8a9a; margin-bottom: 30px; }

        /* Activity */
        .activity-container { width: 100%; max-width: 400px; text-align: center; }

        .activity-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .activity-icon { font-size: 4rem; margin-bottom: 20px; }
        .activity-title { font-size: 1.4rem; font-weight: 600; color: #2d3748; margin-bottom: 12px; }
        .activity-steps { text-align: left; margin: 20px 0; }

        .activity-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px;
            background: #f7fafc;
            border-radius: 10px;
        }

        .step-number {
            width: 28px;
            height: 28px;
            background: #7c3aed;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .step-text { color: #4a5568; line-height: 1.5; }
        .activity-timer { font-size: 2rem; font-weight: 700; color: #7c3aed; margin: 20px 0; }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 350px;
            width: 100%;
            text-align: center;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 12px;
        }

        .modal-text {
            font-size: 1rem;
            color: #7c8a9a;
            margin-bottom: 24px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- Weather Header -->
    <div class="weather-header" id="weatherHeader">
        <div class="weather-top">
            <div>
                <div class="weather-date" id="weatherDate">Loading...</div>
                <div class="weather-day" id="weatherDay">...</div>
            </div>
            <div class="weather-info">
                <div>
                    <div class="weather-temp" id="weatherTemp">--¬∞</div>
                    <div class="weather-desc" id="weatherDesc">--</div>
                </div>
                <div class="weather-icon" id="weatherIcon">üå§Ô∏è</div>
            </div>
        </div>
        <div class="weather-tip">
            <span class="weather-tip-icon">ü§ñ</span>
            <span id="weatherTipText">Set your location in Settings to see weather tips!</span>
        </div>
    </div>

    <header class="header">
        <p class="app-title">FEELFLOW</p>
        <p class="greeting" id="greeting">Hi there!</p>
        <h1 class="question" id="screenTitle">How are you feeling today?</h1>
    </header>

    <!-- SCREEN 1: Emotion Selection -->
    <main class="screen active" id="screen1">
        <div id="streakBanner"></div>
        <div class="emotion-container">
            <button class="emotion-btn happy" onclick="selectEmotion('Happy', 'üòä', '#fcd34d')">
                <span class="emoji">üòä</span>
                <span class="emotion-text">Happy</span>
            </button>
            <button class="emotion-btn sad" onclick="selectEmotion('Sad', 'üò¢', '#93c5fd')">
                <span class="emoji">üò¢</span>
                <span class="emotion-text">Sad</span>
            </button>
            <button class="emotion-btn anxious" onclick="selectEmotion('Anxious', 'üò∞', '#c4b5fd')">
                <span class="emoji">üò∞</span>
                <span class="emotion-text">Anxious</span>
            </button>
            <button class="emotion-btn angry" onclick="selectEmotion('Angry', 'üò†', '#fca5a5')">
                <span class="emoji">üò†</span>
                <span class="emotion-text">Angry</span>
            </button>
            <button class="emotion-btn calm" onclick="selectEmotion('Calm', 'üòå', '#6ee7b7')">
                <span class="emoji">üòå</span>
                <span class="emotion-text">Calm</span>
            </button>
            <button class="emotion-btn tired" onclick="selectEmotion('Tired', 'üò´', '#9ca3af')">
                <span class="emoji">üò´</span>
                <span class="emotion-text">Tired</span>
            </button>
        </div>
        <p class="hint">Tap how you're feeling</p>
    </main>

    <!-- SCREEN 2: Intensity -->
    <main class="screen" id="screen2">
        <div class="selected-emotion-display" id="selectedEmoji">üòä</div>
        <div class="selected-emotion-name" id="selectedName">Happy</div>
        <p class="intensity-question">How strong is this feeling?</p>
        <div class="thermometer-container">
            <div class="intensity-display" id="intensityDisplay">5</div>
            <input type="range" min="1" max="10" value="5" class="intensity-slider" id="intensitySlider" oninput="updateIntensity(this.value)">
            <div class="slider-labels"><span>1 - Mild</span><span>10 - Very Strong</span></div>
        </div>
        <button class="btn btn-primary" onclick="goToResult()">Next</button>
        <button class="btn btn-secondary" onclick="goToScreen(1, 'How are you feeling today?')">‚Üê Back</button>
    </main>

    <!-- SCREEN 3: Result -->
    <main class="screen" id="screen3">
        <div class="result-card">
            <div class="result-emoji" id="resultEmoji">üòä</div>
            <p class="result-text">You're feeling</p>
            <div class="result-intensity" id="resultText">Happy at level 5</div>
            <p class="result-text">Let's find some helpful strategies!</p>
        </div>
        <button class="btn btn-primary" onclick="goToStrategies()" style="margin-top: 30px;">See Strategies</button>
        <button class="btn btn-secondary" onclick="goToScreen(2, 'How strong is it?')">‚Üê Back</button>
    </main>

    <!-- SCREEN 4: Strategies -->
    <main class="screen" id="screen4">
        <div class="strategies-intro">
            <div class="strategies-emoji" id="strategiesEmoji">üò∞</div>
            <p class="strategies-subtitle">Tap a strategy to try it:</p>
        </div>
        <div class="strategies-container" id="strategiesContainer"></div>
        <div class="strategies-footer">
            <button class="btn btn-primary" onclick="finishCheckIn()">Done</button>
            <button class="btn btn-secondary" onclick="goToScreen(3, 'Check-in Complete!')">‚Üê Back</button>
        </div>
    </main>

    <!-- SCREEN 5: Final -->
    <main class="screen" id="screen5">
        <div class="result-card">
            <div class="result-emoji">‚ú®</div>
            <p class="result-text" style="font-size: 1.4rem; font-weight: 600; margin-bottom: 16px;">Great job checking in!</p>
            <p class="result-text" id="finalMessage">Remember: It's okay to feel any emotion.</p>
        </div>
        <button class="btn btn-primary" onclick="startOver()" style="margin-top: 30px;">Check in again</button>
    </main>

    <!-- SCREEN: History -->
    <main class="screen" id="screenHistory">
        <div class="history-container">
            <div style="background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 24px; width: 100%;">
                <div style="font-size: 1rem; font-weight: 600; color: #2d3748; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">üìà 7-Day Emotion Trend</div>
                <canvas id="emotionChart"></canvas>
            </div>
            <div class="stats-grid" id="statsGrid"></div>
            <div class="history-section-title">üìÖ Recent Check-ins</div>
            <div class="history-list" id="historyList"></div>
            <button class="btn btn-danger btn-small clear-history-btn" onclick="clearHistory()">Clear All History</button>
        </div>
    </main>

    <!-- SCREEN: Tracker -->
    <main class="screen" id="screenTracker">
        <div class="tracker-container">
            <!-- Tabs -->
            <div class="tracker-tabs">
                <button class="tracker-tab active" id="tabMorning" onclick="switchRoutine('morning')">
                    <span class="tab-icon">üåÖ</span> Morning
                </button>
                <button class="tracker-tab" id="tabEvening" onclick="switchRoutine('evening')">
                    <span class="tab-icon">üåô</span> Evening
                </button>
            </div>

            <!-- Sticker Reward (shown when complete) -->
            <div class="sticker-reward" id="stickerReward" style="display: none;">
                <div class="sticker-reward-icon">‚≠ê</div>
                <div class="sticker-reward-text">Amazing! You earned a sticker!</div>
                <div class="sticker-reward-sub">All tasks completed</div>
            </div>

            <!-- Progress -->
            <div class="progress-card">
                <div class="progress-header">
                    <span class="progress-title" id="progressTitle">Morning Routine</span>
                    <span class="progress-fraction" id="progressFraction">0/0</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
                </div>
                <div class="progress-message" id="progressMessage">Let's get started!</div>
            </div>

            <!-- Task List -->
            <div class="task-list" id="taskList"></div>

            <!-- Add Task -->
            <div class="add-task-container">
                <input type="text" class="add-task-input" id="addTaskInput" placeholder="Add a new task..." onkeypress="handleTaskKeypress(event)">
                <button class="add-task-btn" onclick="addCustomTask()">+</button>
            </div>

            <!-- Sticker Collection -->
            <div class="sticker-collection">
                <div class="sticker-collection-title">üèÜ This Week's Stickers</div>
                <div class="sticker-grid" id="stickerGrid"></div>
            </div>

            <!-- Weekly Stats -->
            <div class="weekly-stats">
                <div class="weekly-stats-title">üìä Weekly Progress</div>
                <div class="weekly-days" id="weeklyDays"></div>
            </div>
        </div>
    </main>

    <!-- Breathing Screen -->
    <main class="screen" id="screenBreathing">
        <div class="breathing-container">
            <div class="pattern-selector">
                <button class="pattern-btn active" onclick="selectPattern('relaxing')">Relaxing (4-7-8)</button>
                <button class="pattern-btn" onclick="selectPattern('box')">Box Breathing</button>
                <button class="pattern-btn" onclick="selectPattern('quick')">Quick Calm</button>
            </div>
            <div class="breathing-circle-container">
                <div class="breathing-circle" id="breathingCircle"><span class="breathing-icon">ü´Å</span></div>
            </div>
            <div class="breathing-instruction" id="breathingInstruction">Press Start</div>
            <div class="breathing-counter" id="breathingCounter"></div>
            <div class="breathing-progress" id="breathingProgress">5 breaths remaining</div>
            <div class="breathing-buttons">
                <button class="btn btn-primary btn-small" id="breathingStartBtn" onclick="toggleBreathing()">Start</button>
                <button class="btn btn-secondary btn-small" onclick="backToStrategies()">‚Üê Back</button>
            </div>
        </div>
    </main>

    <!-- Grounding Screen -->
    <main class="screen" id="screenGrounding">
        <div class="grounding-progress-bar">
            <div class="progress-dot active" id="dot1"></div>
            <div class="progress-dot" id="dot2"></div>
            <div class="progress-dot" id="dot3"></div>
            <div class="progress-dot" id="dot4"></div>
            <div class="progress-dot" id="dot5"></div>
        </div>
        <div class="grounding-container" id="groundingContainer">
            <div class="grounding-step active" id="groundingStep1">
                <div class="grounding-number">5</div>
                <div class="grounding-sense">üëÄ Things You SEE</div>
                <div class="grounding-prompt">Look around. Name 5 things you can see.</div>
                <div class="grounding-inputs">
                    <input type="text" class="grounding-input" placeholder="1. I see..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="2. I see..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="3. I see..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="4. I see..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="5. I see..." oninput="checkGroundingInput(this)">
                </div>
            </div>
            <div class="grounding-step" id="groundingStep2">
                <div class="grounding-number">4</div>
                <div class="grounding-sense">‚úã Things You TOUCH</div>
                <div class="grounding-prompt">Notice 4 things you can physically feel.</div>
                <div class="grounding-inputs">
                    <input type="text" class="grounding-input" placeholder="1. I feel..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="2. I feel..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="3. I feel..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="4. I feel..." oninput="checkGroundingInput(this)">
                </div>
            </div>
            <div class="grounding-step" id="groundingStep3">
                <div class="grounding-number">3</div>
                <div class="grounding-sense">üëÇ Things You HEAR</div>
                <div class="grounding-prompt">Name 3 sounds you hear.</div>
                <div class="grounding-inputs">
                    <input type="text" class="grounding-input" placeholder="1. I hear..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="2. I hear..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="3. I hear..." oninput="checkGroundingInput(this)">
                </div>
            </div>
            <div class="grounding-step" id="groundingStep4">
                <div class="grounding-number">2</div>
                <div class="grounding-sense">üëÉ Things You SMELL</div>
                <div class="grounding-prompt">Notice 2 things you can smell.</div>
                <div class="grounding-inputs">
                    <input type="text" class="grounding-input" placeholder="1. I smell..." oninput="checkGroundingInput(this)">
                    <input type="text" class="grounding-input" placeholder="2. I smell..." oninput="checkGroundingInput(this)">
                </div>
            </div>
            <div class="grounding-step" id="groundingStep5">
                <div class="grounding-number">1</div>
                <div class="grounding-sense">üëÖ Thing You TASTE</div>
                <div class="grounding-prompt">Notice 1 thing you can taste.</div>
                <div class="grounding-inputs">
                    <input type="text" class="grounding-input" placeholder="1. I taste..." oninput="checkGroundingInput(this)">
                </div>
            </div>
        </div>
        <button class="btn btn-primary" id="groundingNextBtn" onclick="nextGroundingStep()">Next</button>
        <button class="btn btn-secondary" onclick="backToStrategies()">‚Üê Back</button>
    </main>

    <!-- Squeeze Screen -->
    <main class="screen" id="screenSqueeze">
        <div class="squeeze-container">
            <div class="squeeze-visual" id="squeezeVisual">‚úä</div>
            <div class="squeeze-instruction" id="squeezeInstruction">Press Start when ready</div>
            <div class="squeeze-counter" id="squeezeCounter"></div>
            <div class="squeeze-round" id="squeezeRound">3 rounds total</div>
            <div class="breathing-buttons">
                <button class="btn btn-primary btn-small" id="squeezeStartBtn" onclick="toggleSqueeze()">Start</button>
                <button class="btn btn-secondary btn-small" onclick="backToStrategies()">‚Üê Back</button>
            </div>
        </div>
    </main>

    <!-- Activity Screen -->
    <main class="screen" id="screenActivity">
        <div class="activity-container">
            <div class="activity-card">
                <div class="activity-icon" id="activityIcon">üß∏</div>
                <div class="activity-title" id="activityTitle">Comfort Object</div>
                <div class="activity-steps" id="activitySteps"></div>
                <div class="activity-timer" id="activityTimer"></div>
            </div>
            <button class="btn btn-primary" id="activityBtn" onclick="startActivity()">Start</button>
            <button class="btn btn-secondary" onclick="backToStrategies()">‚Üê Back</button>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-btn active" id="navHome" onclick="goHome()">
            <span class="nav-icon">üè†</span>
            <span class="nav-label">Home</span>
        </button>
        <button class="nav-btn" id="navTracker" onclick="goToTracker()">
            <span class="nav-icon">‚úÖ</span>
            <span class="nav-label">Tracker</span>
        </button>
        <button class="nav-btn" id="navHistory" onclick="goToHistory()">
            <span class="nav-icon">üìÖ</span>
            <span class="nav-label">History</span>
        </button>
        <button class="nav-btn" id="navSettings" onclick="goToSettings()">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span class="nav-label">Settings</span>
        </button>
    </nav>

    <!-- SCREEN: Settings -->
    <main class="screen" id="screenSettings">
        <div class="settings-container">
            <div class="settings-section">
                <div class="settings-avatar">üë§</div>
                <div class="settings-section-title">üë§ Profile</div>
                <div class="settings-field">
                    <label class="settings-label">Your Name</label>
                    <input type="text" class="settings-input" id="settingsName" placeholder="Enter your name" oninput="saveSettings()">
                </div>
                <div class="settings-field">
                    <label class="settings-label">Your Age</label>
                    <input type="number" class="settings-input" id="settingsAge" placeholder="Enter your age" min="1" max="120" oninput="saveSettings()">
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">üå§Ô∏è Weather Location</div>
                <div class="settings-field">
                    <button class="settings-location-btn" onclick="requestLocation()">üìç Use My Current Location</button>
                    <div class="location-status" id="locationStatus">Location not set</div>
                </div>
                <div class="settings-field">
                    <label class="settings-label">Or enter your city</label>
                    <input type="text" class="settings-input" id="settingsCity" placeholder="e.g. San Francisco, Seoul" oninput="saveSettings()">
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">üóëÔ∏è Data Management</div>
                <button class="btn btn-danger btn-small" onclick="clearAllData()" style="width:100%">Reset All Data</button>
            </div>
            <div class="settings-saved" id="settingsSaved">‚úì Settings saved!</div>
        </div>
    </main>

   
    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-content">
            <div class="modal-icon">üóëÔ∏è</div>
            <div class="modal-title">Delete Task?</div>
            <div class="modal-text">Are you sure you want to remove this task?</div>
            <div class="modal-buttons">
                <button class="btn btn-secondary btn-small" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger btn-small" onclick="confirmDeleteTask()">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // ===== STATE =====
        let currentEmotion = { name: '', emoji: '', color: '', intensity: 5 };
        let usedStrategies = [];
        let currentRoutine = 'morning';
        let taskToDelete = null;

        // Exercise state
        let breathingInterval = null;
        let breathingActive = false;
        let currentPattern = 'relaxing';
        let breathCount = 0;
        let groundingStep = 1;
        let squeezeInterval = null;
        let squeezeActive = false;
        let activityTimerInterval = null;
        
        // V8 Chart instance
        let emotionChart = null;

function renderEmotionChart() {
    const history = getHistory();
    const canvas = document.getElementById('emotionChart');
    if (!canvas || history.length === 0) return;

    const labels = [];
    const dataPoints = [];
    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const dateString = d.toISOString().split('T')[0];
        labels.push(d.toLocaleDateString('en-US', { weekday: 'short' }));

        const dayEntries = history.filter(h => h.timestamp.startsWith(dateString));
        if (dayEntries.length > 0) {
            const avg = dayEntries.reduce((sum, entry) => sum + parseInt(entry.intensity), 0) / dayEntries.length;
            dataPoints.push(avg.toFixed(1));
        } else {
            dataPoints.push(null);
        }
    }
    
    if (emotionChart) emotionChart.destroy();
    emotionChart = new Chart(canvas, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Intensity',
                data: dataPoints,
                borderColor: '#7c3aed',
                backgroundColor: 'rgba(124, 58, 237, 0.1)',
                borderWidth: 3,
                pointRadius: 5,
                pointBackgroundColor: '#7c3aed',
                tension: 0.3,
                spanGaps: true
            }]
        },
        options: { responsive: true, scales: { y: { min: 0, max: 10 } }, plugins: { legend: { display: false } } }
    });
}

        // V8 end

        // ===== SETTINGS =====
        function getSettings() {
            const data = localStorage.getItem('feelflow_settings');
            return data ? JSON.parse(data) : { name: '', age: '', city: '', lat: null, lon: null };
        }

        function saveSettings() {
            // 1. ÏûÖÎ†• ÏöîÏÜåÎì§ÏùÑ Î®ºÏ†Ä Î≥ÄÏàòÏóê Îã¥ÏäµÎãàÎã§.
            const nameEl = document.getElementById('settingsName');
            const ageEl = document.getElementById('settingsAge');
            const cityEl = document.getElementById('settingsCity');

            // 2. Í∞í(Value)ÏùÑ Í∞ÄÏ†∏ÏôÄÏÑú Ï†ïÎ¶¨Ìï©ÎãàÎã§.
            const nameVal = nameEl.value.trim();
            const ageVal = ageEl.value;
            const cityVal = cityEl.value.trim();
        
            // 3. [Day 10 Í≤ÄÏ¶ù] Ïù¥Î¶ÑÏù¥ ÎπÑÏñ¥ÏûàÎäîÏßÄ Ï≤¥ÌÅ¨ (Í∞ÄÏû• Î®ºÏ†Ä Ïã§Ìñâ)
            if (nameVal === "") {
                // Ï£ºÏùò: oninputÏùº Í≤ΩÏö∞ alertÏù¥ Í≥ÑÏÜç Îú∞ Ïàò ÏûàÏúºÎØÄÎ°ú ÏΩòÏÜîÎ°úÍ∑∏Î°ú ÎåÄÏ≤¥ÌïòÍ±∞ÎÇò 
                // ÎÇòÏ§ëÏóê 'Ï†ÄÏû• Î≤ÑÌäº'ÏùÑ ÎßåÎì§ÏóàÏùÑ Îïå alertÏùÑ Ïì∞Îäî Í≤ÉÏù¥ Ï¢ãÏäµÎãàÎã§.
                console.log("Name is empty");
                return; 
            }
        
            // 4. Í∏∞Ï°¥ ÏÑ§Ï†ïÏùÑ Í∞ÄÏ†∏ÏôÄ ÏúÑÏπò Ï†ïÎ≥¥(lat, lon)Î•º Ïú†ÏßÄÌï©ÎãàÎã§.
            const currentS = getSettings();
        
            // 5. Ï†ÄÏû•Ìï† Í∞ùÏ≤¥ ÏÉùÏÑ±
            const settingsToSave = {
                name: nameVal,
                age: ageVal,
                city: cityVal,
                lat: currentS.lat,
                lon: currentS.lon
            };
        
            // 6. Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû•
            localStorage.setItem('feelflow_settings', JSON.stringify(settingsToSave));
            
            // 7. UI ÏóÖÎç∞Ïù¥Ìä∏
            updateGreeting(); 
            
            // Ï†ÄÏû• ÏôÑÎ£å Ïï†ÎãàÎ©îÏù¥ÏÖò ÌëúÏãú
            const savedNotice = document.getElementById('settingsSaved');
            if (savedNotice) {
                savedNotice.classList.add('show');
                setTimeout(() => savedNotice.classList.remove('show'), 2000);
            }
            
            // 8. ÎÇ†Ïî® ÏóÖÎç∞Ïù¥Ìä∏
            if (cityVal.length > 2) {
                fetchWeatherByCity(cityVal);
            }
            
            // ÏÇ¨Ïö¥Îìú ÌîºÎìúÎ∞± (Day 9)
            if (typeof feedback === 'function') feedback('tap');
        }

        function loadSettings() {
            const settings = getSettings();
            document.getElementById('settingsName').value = settings.name || '';
            document.getElementById('settingsAge').value = settings.age || '';
            document.getElementById('settingsCity').value = settings.city || '';
            if (settings.lat && settings.lon) {
                document.getElementById('locationStatus').textContent = '‚úì Location saved';
                document.getElementById('locationStatus').className = 'location-status success';
            }
            updateGreeting();
        }

        function updateGreeting() {
            const settings = getSettings();
            const greeting = document.getElementById('greeting');
            const hour = new Date().getHours();
            let timeGreeting = hour >= 5 && hour < 12 ? 'Good morning' : hour >= 12 && hour < 18 ? 'Good afternoon' : 'Good evening';
            greeting.textContent = settings.name ? `${timeGreeting}, ${settings.name}!` : `${timeGreeting}!`;
        }

        function requestLocation() {
            const statusEl = document.getElementById('locationStatus');
            if (!navigator.geolocation) {
                statusEl.textContent = '‚ùå Location not supported';
                statusEl.className = 'location-status error';
                return;
            }
            statusEl.textContent = 'üìç Getting location...';
            statusEl.className = 'location-status';
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const settings = getSettings();
                    settings.lat = position.coords.latitude;
                    settings.lon = position.coords.longitude;
                    localStorage.setItem('feelflow_settings', JSON.stringify(settings));
                    statusEl.textContent = '‚úì Location saved!';
                    statusEl.className = 'location-status success';
                    fetchWeatherByCoords(settings.lat, settings.lon);
                },
                () => {
                    statusEl.textContent = '‚ùå Could not get location';
                    statusEl.className = 'location-status error';
                }
            );
        }

        function clearAllData() {
            if (confirm('Delete ALL data including check-ins, tracker, and settings?')) {
                localStorage.clear();
                location.reload();
            }
        }

        // ===== WEATHER =====
        async function fetchWeatherByCoords(lat, lon) {
            try {
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&temperature_unit=fahrenheit&timezone=auto`);
                const data = await response.json();
                displayWeather(data);
            } catch (error) {
                showWeatherFallback();
            }
        }

        async function fetchWeatherByCity(city) {
            try {
                const geoResponse = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1`);
                const geoData = await geoResponse.json();
                if (geoData.results && geoData.results.length > 0) {
                    fetchWeatherByCoords(geoData.results[0].latitude, geoData.results[0].longitude);
                } else {
                    showWeatherFallback();
                }
            } catch (error) {
                showWeatherFallback();
            }
        }

        function displayWeather(data) {
            const now = new Date();
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('weatherDate').textContent = `${months[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;
            document.getElementById('weatherDay').textContent = days[now.getDay()];
            const temp = Math.round(data.current.temperature_2m);
            document.getElementById('weatherTemp').textContent = `${temp}¬∞F`;
            const { icon, description, tip } = getWeatherInfo(data.current.weather_code, temp);
            document.getElementById('weatherIcon').textContent = icon;
            document.getElementById('weatherDesc').textContent = description;
            document.getElementById('weatherTipText').textContent = tip;
        }

        function getWeatherInfo(code, temp) {
            const weatherMap = {
                0: { icon: '‚òÄÔ∏è', description: 'Clear', baseTip: 'Beautiful day!' },
                1: { icon: 'üå§Ô∏è', description: 'Mostly clear', baseTip: 'Nice weather!' },
                2: { icon: '‚õÖ', description: 'Partly cloudy', baseTip: 'Nice day!' },
                3: { icon: '‚òÅÔ∏è', description: 'Cloudy', baseTip: 'Cozy day inside.' },
                45: { icon: 'üå´Ô∏è', description: 'Foggy', baseTip: 'Be careful outside!' },
                51: { icon: 'üåßÔ∏è', description: 'Drizzle', baseTip: 'Grab a jacket!' },
                61: { icon: 'üåßÔ∏è', description: 'Light rain', baseTip: 'Bring an umbrella! ‚òî' },
                63: { icon: 'üåßÔ∏è', description: 'Rain', baseTip: 'Bring an umbrella! ‚òî' },
                65: { icon: 'üåßÔ∏è', description: 'Heavy rain', baseTip: 'Umbrella & raincoat needed! ‚òî' },
                71: { icon: 'üå®Ô∏è', description: 'Light snow', baseTip: 'Dress warmly! üß•' },
                73: { icon: 'üå®Ô∏è', description: 'Snow', baseTip: 'Bundle up! üß§' },
                75: { icon: '‚ùÑÔ∏è', description: 'Heavy snow', baseTip: 'Stay warm! ‚õÑ' },
                95: { icon: '‚õàÔ∏è', description: 'Thunderstorm', baseTip: 'Stay inside! ‚ö°' }
            };
            let info = weatherMap[code] || { icon: 'üå§Ô∏è', description: 'Weather', baseTip: 'Have a great day!' };
            let tip = info.baseTip;
            if (temp < 32) tip = "It's freezing! ü•∂ Wear coat, hat & gloves!";
            else if (temp < 50) tip += " It's chilly - grab a jacket! üß•";
            else if (temp > 90) tip = "Very hot! ü•µ Stay hydrated!";
            else if (temp > 80) tip += " Stay hydrated! üíß";
            return { icon: info.icon, description: info.description, tip };
        }

        function showWeatherFallback() {
            const now = new Date();
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('weatherDate').textContent = `${months[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;
            document.getElementById('weatherDay').textContent = days[now.getDay()];
            document.getElementById('weatherTemp').textContent = '--¬∞';
            document.getElementById('weatherDesc').textContent = 'Set location';
            document.getElementById('weatherTipText').textContent = 'Add location in Settings for weather tips!';
        }

        function initWeather() {
            const settings = getSettings();
            if (settings.lat && settings.lon) fetchWeatherByCoords(settings.lat, settings.lon);
            else if (settings.city) fetchWeatherByCity(settings.city);
            else showWeatherFallback();
        }

        // ===== DEFAULT TASKS =====
        const defaultTasks = {
            morning: [
                { id: 'm1', title: 'Brush teeth', icon: 'ü™•', isDefault: true },
                { id: 'm2', title: 'Wash face', icon: 'üßº', isDefault: true },
                { id: 'm3', title: 'Get dressed', icon: 'üëï', isDefault: true },
                { id: 'm4', title: 'Make bed', icon: 'üõèÔ∏è', isDefault: true },
                { id: 'm5', title: 'Eat breakfast', icon: 'ü•£', isDefault: true },
                { id: 'm6', title: 'Take medication (if needed)', icon: 'üíä', isDefault: true },
            ],
            evening: [
                { id: 'e1', title: 'Brush teeth', icon: 'ü™•', isDefault: true },
                { id: 'e2', title: 'Wash face', icon: 'üßº', isDefault: true },
                { id: 'e3', title: 'Put on pajamas', icon: 'üëö', isDefault: true },
                { id: 'e4', title: 'Prepare clothes for tomorrow', icon: 'üëî', isDefault: true },
                { id: 'e5', title: 'Pack backpack', icon: 'üéí', isDefault: true },
                { id: 'e6', title: 'Read or relax', icon: 'üìñ', isDefault: true },
            ]
        };

        // ===== TRACKER STORAGE =====
        function getTrackerData() {
            const data = localStorage.getItem('feelflow_tracker');
            if (!data) {
                return { tasks: { ...defaultTasks }, completed: {}, stickers: [] };
            }
            const parsed = JSON.parse(data);
            // Ensure tasks exist
            if (!parsed.tasks) parsed.tasks = { ...defaultTasks };
            if (!parsed.completed) parsed.completed = {};
            if (!parsed.stickers) parsed.stickers = [];
            return parsed;
        }

        function saveTrackerData(data) {
            localStorage.setItem('feelflow_tracker', JSON.stringify(data));
        }

        function getTodayKey() {
            return new Date().toISOString().split('T')[0];
        }

        function getCompletedToday(routine) {
            const data = getTrackerData();
            const key = `${getTodayKey()}_${routine}`;
            return data.completed[key] || [];
        }

        function toggleTaskComplete(taskId) {
            const data = getTrackerData();
            const key = `${getTodayKey()}_${currentRoutine}`;
            if (!data.completed[key]) data.completed[key] = [];

            const index = data.completed[key].indexOf(taskId);
            if (index > -1) {
                data.completed[key].splice(index, 1);
            } else {
                data.completed[key].push(taskId);
            }

            saveTrackerData(data);
            renderTracker();
            checkForSticker();
        }

        function checkForSticker() {
            const data = getTrackerData();
            const tasks = data.tasks[currentRoutine] || [];
            const completed = getCompletedToday(currentRoutine);
            const allComplete = tasks.length > 0 && tasks.every(t => completed.includes(t.id));

            const stickerKey = `${getTodayKey()}_${currentRoutine}`;
            const alreadyEarned = data.stickers.includes(stickerKey);

            if (allComplete && !alreadyEarned) {
                data.stickers.push(stickerKey);
                saveTrackerData(data);
                showStickerReward();
            }

            document.getElementById('stickerReward').style.display = allComplete ? 'block' : 'none';
        }

        function showStickerReward() {
            const reward = document.getElementById('stickerReward');
            reward.style.display = 'block';
            reward.style.animation = 'none';
            setTimeout(() => reward.style.animation = 'celebrate 0.5s ease', 10);
        }

        function addCustomTask() {
            const input = document.getElementById('addTaskInput');
            const title = input.value.trim();
            if (!title) return;

            const data = getTrackerData();
            const newTask = {
                id: `custom_${Date.now()}`,
                title: title,
                icon: 'üìå',
                isDefault: false
            };

            if (!data.tasks[currentRoutine]) {
                data.tasks[currentRoutine] = [...defaultTasks[currentRoutine]];
            }
            data.tasks[currentRoutine].push(newTask);
            saveTrackerData(data);

            input.value = '';
            renderTracker();
        }

        function handleTaskKeypress(event) {
            if (event.key === 'Enter') addCustomTask();
        }

        function deleteTask(taskId) {
            taskToDelete = taskId;
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            taskToDelete = null;
        }

        function confirmDeleteTask() {
            if (!taskToDelete) return;

            const data = getTrackerData();
            data.tasks[currentRoutine] = data.tasks[currentRoutine].filter(t => t.id !== taskToDelete);

            // Also remove from completed
            Object.keys(data.completed).forEach(key => {
                data.completed[key] = data.completed[key].filter(id => id !== taskToDelete);
            });

            saveTrackerData(data);
            closeDeleteModal();
            renderTracker();
        }

        function switchRoutine(routine) {
            currentRoutine = routine;
            document.getElementById('tabMorning').classList.toggle('active', routine === 'morning');
            document.getElementById('tabEvening').classList.toggle('active', routine === 'evening');
            renderTracker();
        }

        function renderTracker() {
            const data = getTrackerData();
            const tasks = data.tasks[currentRoutine] || defaultTasks[currentRoutine];
            const completed = getCompletedToday(currentRoutine);

            const taskList = document.getElementById('taskList');
            if (!taskList) return; // ÏöîÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ Ï§ëÎã®
            
            // 1. Progress Í≥ÑÏÇ∞
            const total = tasks.length;
            const done = completed.length;
            const percent = total > 0 ? Math.round((done / total) * 100) : 0;

            // 2. ÏÉÅÎã® ÏßÑÌñâÎ•† ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('progressTitle').textContent = currentRoutine === 'morning' ? 'üåÖ Morning Routine' : 'üåô Evening Routine';
            document.getElementById('progressFraction').textContent = `${done}/${total}`;
            document.getElementById('progressBar').style.width = `${percent}%`;

            // 3. Day 10: ÌÉúÏä§ÌÅ¨Í∞Ä ÌïòÎÇòÎèÑ ÏóÜÏùÑ Îïå Ï≤òÎ¶¨
            if (total === 0) {
                taskList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #7c8a9a;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">‚ú®</div>
                        <p>Your list is empty.<br>Add a task below to get started!</p>
                    </div>
                `;
                document.getElementById('progressMessage').textContent = "Add your first task!";
                return; 
            }

            // 4. ÏßÑÌñâÎ•† Î©îÏãúÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
            let message = "Let's get started!";
            if (percent === 100) message = "üéâ All done! Amazing work!";
            else if (percent >= 75) message = "Almost there! Keep going!";
            else if (percent >= 50) message = "Halfway done! Great progress!";
            else if (percent > 0) message = "Good start! Keep it up!";
            document.getElementById('progressMessage').textContent = message;

            // 5. Ïä§Ìã∞Ïª§ Î≥¥ÏÉÅ ÌôïÏù∏
            const stickerKey = `${getTodayKey()}_${currentRoutine}`;
            const earnedSticker = data.stickers.includes(stickerKey);
            const stickerRewardEl = document.getElementById('stickerReward');
            if (stickerRewardEl) {
                stickerRewardEl.style.display = earnedSticker ? 'block' : 'none';
            }

            // 6. ÌÉúÏä§ÌÅ¨ Î¶¨Ïä§Ìä∏ Î†åÎçîÎßÅ
            taskList.innerHTML = tasks.map(task => {
                const isComplete = completed.includes(task.id);
                return `
                    <div class="task-item ${isComplete ? 'completed' : ''}" onclick="toggleTaskComplete('${task.id}')">
                        <div class="task-checkbox">${isComplete ? '‚úì' : ''}</div>
                        <div class="task-content">
                            <div class="task-title">${task.title}</div>
                        </div>
                        <div class="task-icon">${task.icon}</div>
                        ${!task.isDefault ? `<button class="task-delete" onclick="event.stopPropagation(); deleteTask('${task.id}')">√ó</button>` : ''}
                    </div>
                `;
            }).join('');

            // 7. ÌïòÎã® ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            renderStickerCollection();
            renderWeeklyStats();
        }

        function renderStickerCollection() {
            const data = getTrackerData();
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());

            const grid = document.getElementById('stickerGrid');
            let html = '';

            for (let i = 0; i < 14; i++) { // 7 days √ó 2 routines
                const dayOffset = Math.floor(i / 2);
                const routine = i % 2 === 0 ? 'morning' : 'evening';
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + dayOffset);
                const dateKey = date.toISOString().split('T')[0];
                const stickerKey = `${dateKey}_${routine}`;

                const earned = data.stickers.includes(stickerKey);
                const icon = routine === 'morning' ? 'üåÖ' : 'üåô';

                html += `<div class="sticker-slot ${earned ? 'earned' : 'empty'}">${earned ? '‚≠ê' : icon}</div>`;
            }

            grid.innerHTML = html;
        }

        function renderWeeklyStats() {
            const data = getTrackerData();
            const today = new Date();
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            const weeklyDays = document.getElementById('weeklyDays');
            let html = '';

            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - today.getDay() + i);
                const dateKey = date.toISOString().split('T')[0];

                const morningKey = `${dateKey}_morning`;
                const eveningKey = `${dateKey}_evening`;

                const morningEarned = data.stickers.includes(morningKey);
                const eveningEarned = data.stickers.includes(eveningKey);

                const isToday = dateKey === getTodayKey();
                let status = 'missed';
                let icon = '¬∑';

                if (morningEarned && eveningEarned) {
                    status = 'completed';
                    icon = '‚úì';
                } else if (morningEarned || eveningEarned) {
                    status = 'partial';
                    icon = '¬Ω';
                }

                // Future dates
                if (date > today) {
                    status = 'missed';
                    icon = '¬∑';
                }

                html += `
                    <div class="weekly-day">
                        <div class="weekly-day-label">${days[i]}</div>
                        <div class="weekly-day-status ${status} ${isToday ? 'today' : ''}">${icon}</div>
                    </div>
                `;
            }

            weeklyDays.innerHTML = html;
        }

        // ===== EMOTION HISTORY =====
        function getHistory() {
            const data = localStorage.getItem('feelflow_history');
            return data ? JSON.parse(data) : [];
        }

        // index.html ÎÇ¥Ïùò saveCheckIn Ìï®Ïàò ÏàòÏ†ï ÏòàÏãú
        async function saveCheckIn(entry) {
            // 1. Í∏∞Ï°¥ Î°úÏª¨ Ï†ÄÏû• (ÏÑúÎ≤Ñ Ïû•Ïï† Ïãú Î∞±ÏóÖÏö©)
            const history = JSON.parse(localStorage.getItem('emotionHistory') || '[]');
            history.unshift(entry);
            localStorage.setItem('emotionHistory', JSON.stringify(history));
        
            // 2. ÏÑúÎ≤Ñ DBÎ°ú Ï†ÑÏÜ° (API_BASE_URL Î≥ÄÏàò ÌôúÏö©)
            try {
                // Î∞±Ìã±(`)ÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ API_BASE_URL Î≥ÄÏàòÏôÄ Í≤ΩÎ°úÎ•º Ìï©Ïπ©ÎãàÎã§.
                const response = await fetch(`${API_BASE_URL}/emotions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entry)
                });
        
                if (response.ok) {
                    console.log("Successfully synced to DB! ‚úÖ");
                } else {
                    console.warn("Server responded but failed to save. ‚ö†Ô∏è");
                }
            } catch (error) {
                // Ïò§ÌîÑÎùºÏù∏ ÏÉÅÌÉúÏù¥Í±∞ÎÇò ngrokÏù¥ Í∫ºÏ†∏ ÏûàÏùÑ Îïå Î∞úÏÉùÌï©ÎãàÎã§.
                console.error("Network error. Data kept in LocalStorage only. ‚ö†Ô∏è", error);
            }
        }

        // Day 15: ÏÑúÎ≤ÑÎ°ú Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ°ÌïòÎäî Ìï®Ïàò ÏòàÏãú
        async function syncToBackend(data) {
            try {
                const response = await fetch('http://localhost:3000/api/emotions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return await response.json();
            } catch (e) {
                console.error("Backend sync failed:", e);
            }
        }


        function clearHistory() {
            if (confirm('Clear all check-in history?')) {
                localStorage.removeItem('feelflow_history');
                renderHistory();
            }
        }

        function getStats() {
            const history = getHistory();
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const thisWeek = history.filter(h => new Date(h.timestamp) >= weekAgo);

            const emotionCounts = {};
            const emojis = { Happy: 'üòä', Sad: 'üò¢', Anxious: 'üò∞', Angry: 'üò†', Calm: 'üòå', Tired: 'üò´' };
            history.forEach(h => emotionCounts[h.emotion] = (emotionCounts[h.emotion] || 0) + 1);

            let topEmotion = null;
            for (const [emotion, count] of Object.entries(emotionCounts)) {
                if (!topEmotion || count > topEmotion.count) {
                    topEmotion = { name: emotion, emoji: emojis[emotion], count };
                }
            }

            return { thisWeek: thisWeek.length, total: history.length, topEmotion, streak: calculateStreak(history) };
        }

        function calculateStreak(history) {
            if (!history.length) return 0;
            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let checkDate = new Date(today);
            const hasToday = history.some(h => {
                const d = new Date(h.timestamp);
                d.setHours(0, 0, 0, 0);
                return d.getTime() === today.getTime();
            });

            if (!hasToday) {
                checkDate.setDate(checkDate.getDate() - 1);
                const hasYesterday = history.some(h => {
                    const d = new Date(h.timestamp);
                    d.setHours(0, 0, 0, 0);
                    return d.getTime() === checkDate.getTime();
                });
                if (!hasYesterday) return 0;
            }

            for (let i = 0; i < 365; i++) {
                const has = history.some(h => {
                    const d = new Date(h.timestamp);
                    d.setHours(0, 0, 0, 0)
                    return d.getTime() === checkDate.getTime();
                });
                if (has) { streak++; checkDate.setDate(checkDate.getDate() - 1); }
                else break;
            }
            return streak;
        }

        function updateStreakBanner() {
            const stats = getStats();
            document.getElementById('streakBanner').innerHTML = stats.streak >= 2
                ? `<div class="streak-banner"><span>üî•</span><span>${stats.streak} day streak!</span></div>`
                : '';
        }

        function renderHistory() {
            const history = getHistory();
            const stats = getStats();

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card"><div class="stat-value">${stats.thisWeek}</div><div class="stat-label">This Week</div></div>
                <div class="stat-card"><div class="stat-value">${stats.total}</div><div class="stat-label">Total Check-ins</div></div>
                ${stats.topEmotion ? `<div class="stat-card wide"><div class="stat-label" style="margin-bottom:8px">Most Frequent</div><div class="top-emotion"><span class="top-emotion-emoji">${stats.topEmotion.emoji}</span><span class="top-emotion-name">${stats.topEmotion.name}</span></div></div>` : ''}
                ${stats.streak >= 2 ? `<div class="stat-card wide" style="background:linear-gradient(135deg,#fef3c7,#fde68a)"><div class="stat-value">üî• ${stats.streak}</div><div class="stat-label">Day Streak</div></div>` : ''}
            `;

            if (!history.length) {
                document.getElementById('historyList').innerHTML = '<div class="empty-history"><div class="empty-history-icon">üìù</div><div class="empty-history-text">No check-ins yet</div></div>';
                return;
            }

            const grouped = {};
            history.forEach(item => {
                const date = new Date(item.timestamp);
                const today = new Date().toDateString();
                const yesterday = new Date(Date.now() - 86400000).toDateString();
                let label = date.toDateString() === today ? 'Today' : date.toDateString() === yesterday ? 'Yesterday' : date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                if (!grouped[label]) grouped[label] = [];
                grouped[label].push(item);
            });

            document.getElementById('historyList').innerHTML = Object.entries(grouped).map(([date, items]) => `
                <div class="history-date-group">
                    <div class="history-date-label">${date}</div>
                    ${items.map(item => `
                        <div class="history-item">
                            <div class="history-emoji">${item.emoji}</div>
                            <div class="history-details">
                                <div class="history-emotion">${item.emotion}</div>
                                <div class="history-meta">${new Date(item.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}${item.strategies?.length ? ' ‚Ä¢ ' + item.strategies.join(', ') : ''}</div>
                            </div>
                            <div class="history-level">Lvl ${item.intensity}</div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        // ===== STRATEGIES =====
        const strategies = {
            Happy: [
                { icon: 'üìù', title: 'Write It Down', description: 'Write what made you happy.', type: 'activity', activityType: 'journal' },
                { icon: 'üì∏', title: 'Capture the Moment', description: 'Take a photo to remember.', type: 'simple' },
                { icon: 'üéâ', title: 'Share Your Joy', description: 'Tell someone you trust.', type: 'simple' }
            ],
            Sad: [
                { icon: 'üß∏', title: 'Comfort Object', description: 'Hold something soft.', type: 'activity', activityType: 'comfort', hasDetail: true },
                { icon: 'üéµ', title: 'Listen to Music', description: 'Play calming songs.', type: 'activity', activityType: 'music', hasDetail: true },
                { icon: 'üí¨', title: 'Talk to Someone', description: 'Share how you feel.', type: 'simple' }
            ],
            Anxious: [
                { icon: 'ü´Å', title: 'Deep Breathing', description: 'Guided breathing exercises.', type: 'breathing', hasDetail: true },
                { icon: '5Ô∏è‚É£', title: '5-4-3-2-1 Grounding', description: 'Use your senses.', type: 'grounding', hasDetail: true },
                { icon: 'üßä', title: 'Hold Something Cold', description: 'Ice to calm down.', type: 'activity', activityType: 'cold', hasDetail: true }
            ],
            Angry: [
                { icon: 'üö∂', title: 'Take a Walk', description: 'Move for 5 minutes.', type: 'activity', activityType: 'walk', hasDetail: true },
                { icon: 'üßÆ', title: 'Count Backwards', description: '10 to 1 with breaths.', type: 'activity', activityType: 'count', hasDetail: true },
                { icon: '‚úä', title: 'Squeeze and Release', description: 'Tense and relax muscles.', type: 'squeeze', hasDetail: true }
            ],
            Calm: [
                { icon: 'üßò', title: 'Mindful Moment', description: 'Notice how calm feels.', type: 'activity', activityType: 'mindful', hasDetail: true },
                { icon: 'üìñ', title: 'Quiet Activity', description: 'Read, draw, or hobby.', type: 'simple' },
                { icon: 'üí≠', title: 'Positive Thoughts', description: '3 things you\'re grateful for.', type: 'activity', activityType: 'gratitude', hasDetail: true }
            ],
            Tired: [
                { icon: 'üíß', title: 'Drink Water', description: 'Hydration helps.', type: 'simple' },
                { icon: 'üå¨Ô∏è', title: 'Fresh Air', description: 'Step outside 2 mins.', type: 'activity', activityType: 'freshair', hasDetail: true },
                { icon: 'üò¥', title: 'Rest Your Eyes', description: 'Close eyes 1 minute.', type: 'activity', activityType: 'rest', hasDetail: true }
            ]
        };

        const activityDetails = {
            comfort: { icon: 'üß∏', title: 'Comfort Object', steps: ['Find something soft', 'Hold it close', 'Notice how it feels', 'Take 3 deep breaths', 'Stay as long as needed'], timerSeconds: 60 },
            music: { icon: 'üéµ', title: 'Listen to Music', steps: ['Find a quiet spot', 'Put on headphones', 'Play a calming song', 'Close your eyes', 'Let music fill your mind'], timerSeconds: 180 },
            cold: { icon: 'üßä', title: 'Hold Something Cold', steps: ['Get ice or cold water', 'Hold in your hands', 'Focus on the cold', 'Notice your body', 'Resets nervous system'], timerSeconds: 60 },
            walk: { icon: 'üö∂', title: 'Take a Walk', steps: ['Stretch your arms', 'Walk for 5 minutes', 'Notice feet on ground', 'Look around you', 'Release energy'], timerSeconds: 300 },
            count: { icon: 'üßÆ', title: 'Count Backwards', steps: ['Sit comfortably', 'Breathe in deep', 'Breathe out say "10"', 'Count down to 1', 'Breath with each number'], timerSeconds: 30 },
            mindful: { icon: 'üßò', title: 'Mindful Moment', steps: ['Sit and close eyes', 'Notice body feelings', 'Feel calm in chest', 'Smile gently', 'Enjoy this moment'], timerSeconds: 60 },
            gratitude: { icon: 'üí≠', title: 'Gratitude', steps: ['Think of a person', 'Think of a thing', 'Think of a place', 'Notice the feeling', 'Carry it with you'], timerSeconds: 60 },
            freshair: { icon: 'üå¨Ô∏è', title: 'Fresh Air', steps: ['Open window or go outside', 'Breathe fresh air', 'Feel temperature', 'Listen to sounds', 'Wake yourself up'], timerSeconds: 120 },
            rest: { icon: 'üò¥', title: 'Rest Your Eyes', steps: ['Sit back or lie down', 'Close your eyes', 'Relax face muscles', 'Just rest', 'Open when timer ends'], timerSeconds: 60 },
            journal: { icon: 'üìù', title: 'Happy Journal', steps: ['Get paper or phone', 'Write "I feel happy because..."', 'Add details', 'Draw if you like', 'Save for later'], timerSeconds: 180 }
        };

        // ===== CORE NAVIGATION =====
        function selectEmotion(name, emoji, color) {
            feedback('tap'); // added
            currentEmotion = { name, emoji, color, intensity: 5 };
            usedStrategies = [];
            document.getElementById('selectedEmoji').textContent = emoji;
            document.getElementById('selectedName').textContent = name;
            document.getElementById('intensitySlider').value = 5;
            updateIntensity(5);
            goToScreen(2, 'How strong is it?');
        }
        function updateIntensity(value) {
            currentEmotion.intensity = value;
            const display = document.getElementById('intensityDisplay');
            display.textContent = value;
            const intensity = value / 10;
            const hex = currentEmotion.color.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16), g = parseInt(hex.substr(2, 2), 16), b = parseInt(hex.substr(4, 2), 16);
            display.style.color = `rgb(${Math.round(200 + (r - 200) * intensity)}, ${Math.round(200 + (g - 200) * intensity)}, ${Math.round(200 + (b - 200) * intensity)})`;
        }

        function goToResult() {
            document.getElementById('resultEmoji').textContent = currentEmotion.emoji;
            document.getElementById('resultText').textContent = `${currentEmotion.name} at level ${currentEmotion.intensity}`;
            goToScreen(3, 'Check-in Complete!');
        }

        function goToStrategies() {
            document.getElementById('strategiesEmoji').textContent = currentEmotion.emoji;
            const container = document.getElementById('strategiesContainer');
            container.innerHTML = strategies[currentEmotion.name].map(s => `
                <div class="strategy-card ${s.hasDetail ? 'has-detail' : ''}" onclick='openStrategy(${JSON.stringify(s)})'>
                    <div class="strategy-icon">${s.icon}</div>
                    <div class="strategy-content">
                        <div class="strategy-title">${s.title}</div>
                        <div class="strategy-description">${s.description}</div>
                        ${s.hasDetail ? '<span class="strategy-badge">TAP TO TRY</span>' : ''}
                    </div>
                </div>
            `).join('');
            goToScreen(4, 'Helpful Strategies');
        }

        function openStrategy(strategy) {
            if (!usedStrategies.includes(strategy.title)) usedStrategies.push(strategy.title);
            if (strategy.type === 'breathing') { resetBreathing(); goToScreen('Breathing', 'Deep Breathing'); }
            else if (strategy.type === 'grounding') { resetGrounding(); goToScreen('Grounding', '5-4-3-2-1 Grounding'); }
            else if (strategy.type === 'squeeze') { resetSqueeze(); goToScreen('Squeeze', 'Squeeze & Release'); }
            else if (strategy.type === 'activity' && activityDetails[strategy.activityType]) { setupActivity(strategy.activityType); goToScreen('Activity', strategy.title); }
        }

        function backToStrategies() { stopAllExercises(); goToScreen(4, 'Helpful Strategies'); }

        function finishCheckIn() {
            saveCheckIn(currentEmotion.name, currentEmotion.emoji, currentEmotion.intensity, usedStrategies);
            const stats = getStats();
            document.getElementById('finalMessage').textContent = stats.streak >= 3 ? `üî• ${stats.streak} day streak!` : stats.total === 1 ? "Great first check-in!" : "You're doing great!";
            goToScreen(5, 'You Did It!');
        }

        function startOver() { stopAllExercises(); usedStrategies = []; updateStreakBanner(); goHome(); }

        function goHome() {
            stopAllExercises();
            updateStreakBanner();
            updateGreeting();
            document.getElementById('weatherHeader').style.display = 'block';
            document.getElementById('greeting').style.display = 'block';
            goToScreen(1, 'How are you feeling today?');
            updateNavActive('navHome');
        }

        function goToHistory() {
            document.getElementById('weatherHeader').style.display = 'none';
            document.getElementById('greeting').style.display = 'none';
            renderHistory();
            renderEmotionChart(); // Ïù¥ Ï§ÑÏùÑ Ï∂îÍ∞Ä!
            goToScreen('History', 'My Check-ins');
            updateNavActive('navHistory');
        }

        function goToTracker() {
            document.getElementById('weatherHeader').style.display = 'none';
            document.getElementById('greeting').style.display = 'none';
            renderTracker();
            goToScreen('Tracker', 'Life Skills Tracker');
            updateNavActive('navTracker');
        }

        function goToSettings() {
            document.getElementById('weatherHeader').style.display = 'none';
            document.getElementById('greeting').style.display = 'none';
            loadSettings();
            goToScreen('Settings', 'Settings');
            updateNavActive('navSettings');
        }

        function updateNavActive(id) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function goToScreen(screen, title) {
            feedback('tap'); // Ï∂îÍ∞Ä
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(typeof screen === 'number' ? `screen${screen}` : `screen${screen}`).classList.add('active');
            document.getElementById('screenTitle').textContent = title;
        }

        function stopAllExercises() {
            [breathingInterval, squeezeInterval, activityTimerInterval].forEach(i => i && clearInterval(i));
            breathingActive = squeezeActive = false;
        }

        // ===== BREATHING =====
        const breathingPatterns = { relaxing: { inhale: 4, hold: 7, exhale: 8, rounds: 5 }, box: { inhale: 4, hold: 4, exhale: 4, holdAfter: 4, rounds: 5 }, quick: { inhale: 3, hold: 0, exhale: 6, rounds: 5 } };

        function selectPattern(p) { currentPattern = p; document.querySelectorAll('.pattern-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); resetBreathing(); }

        function resetBreathing() {
            if (breathingInterval) clearInterval(breathingInterval);
            breathingActive = false; breathCount = 0;
            document.getElementById('breathingStartBtn').textContent = 'Start';
            document.getElementById('breathingInstruction').textContent = 'Press Start';
            document.getElementById('breathingCounter').textContent = '';
            document.getElementById('breathingProgress').textContent = `${breathingPatterns[currentPattern].rounds} breaths remaining`;
            document.getElementById('breathingCircle').className = 'breathing-circle';
        }

        function toggleBreathing() { if (breathingActive) resetBreathing(); else { breathingActive = true; document.getElementById('breathingStartBtn').textContent = 'Stop'; runBreathingCycle(); } }

        function runBreathingCycle() {
            const p = breathingPatterns[currentPattern];
            const circle = document.getElementById('breathingCircle'), instr = document.getElementById('breathingInstruction'), counter = document.getElementById('breathingCounter'), prog = document.getElementById('breathingProgress');
            let phase = 'inhale', count = p.inhale;

            const tick = () => {
                if (!breathingActive) return;
                counter.textContent = count;
                if (phase === 'inhale') { instr.textContent = 'Breathe In...'; circle.className = 'breathing-circle inhale'; if (count <= 0) { phase = p.hold > 0 ? 'hold' : 'exhale'; count = phase === 'hold' ? p.hold : p.exhale; circle.className = 'breathing-circle hold'; } }
                else if (phase === 'hold') { instr.textContent = 'Hold...'; if (count <= 0) { phase = 'exhale'; count = p.exhale; } }
                else if (phase === 'exhale') { instr.textContent = 'Breathe Out...'; circle.className = 'breathing-circle exhale'; if (count <= 0) { if (p.holdAfter) { phase = 'holdAfter'; count = p.holdAfter; } else { breathCount++; if (breathCount >= p.rounds) { completeBreathing(); return; } phase = 'inhale'; count = p.inhale; } } }
                else if (phase === 'holdAfter') { instr.textContent = 'Hold...'; circle.className = 'breathing-circle hold'; if (count <= 0) { breathCount++; if (breathCount >= p.rounds) { completeBreathing(); return; } phase = 'inhale'; count = p.inhale; } }
                prog.textContent = `${p.rounds - breathCount} breaths remaining`;
                count--;
            };
            tick(); breathingInterval = setInterval(tick, 1000);
        }

        function completeBreathing() { breathingActive = false; clearInterval(breathingInterval); document.getElementById('breathingInstruction').textContent = 'Great job! üéâ'; document.getElementById('breathingCounter').textContent = '‚úì'; document.getElementById('breathingProgress').textContent = 'Complete'; document.getElementById('breathingStartBtn').textContent = 'Again'; document.getElementById('breathingCircle').className = 'breathing-circle'; }

        // ===== GROUNDING =====
        function resetGrounding() {
            groundingStep = 1;
            for (let i = 1; i <= 5; i++) { document.getElementById(`groundingStep${i}`).classList.remove('active'); document.getElementById(`dot${i}`).classList.remove('active', 'completed'); document.getElementById(`groundingStep${i}`).querySelectorAll('input').forEach(inp => { inp.value = ''; inp.classList.remove('filled'); }); }
            document.getElementById('groundingStep1').classList.add('active');
            document.getElementById('dot1').classList.add('active');
            document.getElementById('groundingNextBtn').textContent = 'Next';
            document.getElementById('groundingNextBtn').onclick = nextGroundingStep;
        }

        function checkGroundingInput(inp) { inp.classList.toggle('filled', inp.value.trim().length > 0); }

        function nextGroundingStep() {
            if (groundingStep >= 5) { document.getElementById('screenTitle').textContent = 'Well Done! üéâ'; document.getElementById('groundingNextBtn').textContent = 'Finish'; document.getElementById('groundingNextBtn').onclick = backToStrategies; return; }
            document.getElementById(`dot${groundingStep}`).classList.remove('active'); document.getElementById(`dot${groundingStep}`).classList.add('completed'); document.getElementById(`groundingStep${groundingStep}`).classList.remove('active');
            groundingStep++;
            document.getElementById(`dot${groundingStep}`).classList.add('active'); document.getElementById(`groundingStep${groundingStep}`).classList.add('active');
            const senses = ['', 'See', 'Touch', 'Hear', 'Smell', 'Taste'];
            document.getElementById('screenTitle').textContent = `${6 - groundingStep} Things You ${senses[groundingStep]}`;
        }

        // ===== SQUEEZE =====
        function resetSqueeze() { if (squeezeInterval) clearInterval(squeezeInterval); squeezeActive = false; document.getElementById('squeezeStartBtn').textContent = 'Start'; document.getElementById('squeezeInstruction').textContent = 'Press Start'; document.getElementById('squeezeCounter').textContent = ''; document.getElementById('squeezeRound').textContent = '3 rounds'; document.getElementById('squeezeVisual').className = 'squeeze-visual'; document.getElementById('squeezeVisual').textContent = '‚úä'; }

        function toggleSqueeze() { if (squeezeActive) resetSqueeze(); else { squeezeActive = true; document.getElementById('squeezeStartBtn').textContent = 'Stop'; runSqueezeExercise(); } }

        function runSqueezeExercise() {
            const vis = document.getElementById('squeezeVisual'), instr = document.getElementById('squeezeInstruction'), counter = document.getElementById('squeezeCounter'), roundDisp = document.getElementById('squeezeRound');
            let phase = 'squeeze', count = 5, round = 1;
            const tick = () => {
                if (!squeezeActive) return;
                counter.textContent = count; counter.className = phase === 'squeeze' ? 'squeeze-counter' : 'squeeze-counter release';
                if (phase === 'squeeze') { instr.textContent = 'SQUEEZE! üí™'; vis.className = 'squeeze-visual squeezing'; vis.textContent = '‚úä'; if (count <= 0) { phase = 'release'; count = 5; } }
                else { instr.textContent = 'Release... üòå'; vis.className = 'squeeze-visual releasing'; vis.textContent = 'üñêÔ∏è'; if (count <= 0) { round++; if (round > 3) { completeSqueeze(); return; } phase = 'squeeze'; count = 5; roundDisp.textContent = `Round ${round}/3`; } }
                count--;
            };
            tick(); squeezeInterval = setInterval(tick, 1000);
        }

        function completeSqueeze() { squeezeActive = false; clearInterval(squeezeInterval); document.getElementById('squeezeInstruction').textContent = 'Great job! üéâ'; document.getElementById('squeezeCounter').textContent = '‚úì'; document.getElementById('squeezeRound').textContent = 'Complete'; document.getElementById('squeezeStartBtn').textContent = 'Again'; document.getElementById('squeezeVisual').className = 'squeeze-visual'; document.getElementById('squeezeVisual').textContent = 'üôå'; }

        // ===== ACTIVITY =====
        function setupActivity(type) {
            const a = activityDetails[type];
            document.getElementById('activityIcon').textContent = a.icon;
            document.getElementById('activityTitle').textContent = a.title;
            document.getElementById('activitySteps').innerHTML = a.steps.map((s, i) => `<div class="activity-step"><div class="step-number">${i + 1}</div><div class="step-text">${s}</div></div>`).join('');
            document.getElementById('activityTimer').textContent = '';
            document.getElementById('activityBtn').textContent = 'Start Timer';
            document.getElementById('activityBtn').onclick = () => startActivityTimer(a.timerSeconds);
        }

        function startActivityTimer(secs) {
            // 1. ÏãúÏûë ÏÜåÎ¶¨ Ïû¨ÏÉù
            playStartSound(); 
        
            if (activityTimerInterval) clearInterval(activityTimerInterval);
            
            let rem = secs; // ÎÇ®ÏùÄ ÏãúÍ∞ÑÏùÑ Í¥ÄÎ¶¨ÌïòÎäî Î≥ÄÏàòÎäî 'rem'ÏûÖÎãàÎã§.
            const disp = document.getElementById('activityTimer');
            const btn = document.getElementById('activityBtn');
        
            btn.textContent = 'Stop';
            btn.onclick = () => { 
                clearInterval(activityTimerInterval); 
                disp.textContent = 'Paused'; 
                btn.textContent = 'Continue'; 
                btn.onclick = () => startActivityTimer(rem); 
            };
        
            const upd = () => {
                // ÌôîÎ©¥Ïóê Î∂Ñ:Ï¥à ÌëúÏãú
                disp.textContent = `${Math.floor(rem / 60)}:${(rem % 60).toString().padStart(2, '0')}`;
                
                // --- ÏàòÏ†ï Ìè¨Ïù∏Ìä∏ 1: Î≥ÄÏàòÎ™Ö ÌÜµÏùº (timeLeft -> rem) ---
                // 0Ï¥àÍ∞Ä ÎêòÍ∏∞ Ï†ÑÍπåÏßÄ Îß§Ï¥à Ïß∏Íπç ÏÜåÎ¶¨Î•º ÎÉÖÎãàÎã§.
                if (rem > 0) {
                    playTickSound(); 
                }
        
                // --- ÏàòÏ†ï Ìè¨Ïù∏Ìä∏ 2: Ï¢ÖÎ£å Î°úÏßÅ ---
                if (rem <= 0) { 
                    clearInterval(activityTimerInterval); 
                    playTimerEndSound(); // Ï¢ÖÎ£å ÏÜåÎ¶¨ Ïû¨ÏÉù
                    // [Day 11] Î∏åÎùºÏö∞Ï†Ä ÏïåÎ¶º Ï∂îÍ∞Ä
                    sendNotification("FeelFlow", "Timer is finished! Great job, Jason! üéâ");
                    disp.textContent = 'Done! üéâ'; 
                    btn.textContent = 'Restart'; 
                    btn.onclick = () => startActivityTimer(secs); 
                    return; // Ï¢ÖÎ£å Ïãú Ìï®Ïàò Ïã§Ìñâ Ï§ëÎã®
                } 
                
                rem--; // ÏãúÍ∞Ñ Ï∞®Í∞ê
            };
        
            upd(); 
            activityTimerInterval = setInterval(upd, 1000);
        }
        // Init
       // Day 11: ÏãúÏä§ÌÖú ÏïåÎ¶º Ï†ÑÏÜ° Ìï®Ïàò
       function sendNotification(title, message) {
        // Î∏åÎùºÏö∞Ï†ÄÍ∞Ä ÏïåÎ¶ºÏùÑ ÏßÄÏõêÌïòÍ≥† Í∂åÌïúÏù¥ ÌóàÏö©Îêú Í≤ΩÏö∞Îßå Ïã§Ìñâ
        if (!("Notification" in window)) return;

        if (Notification.permission === "granted") {
            new Notification(title, {
                body: message,
                icon: "https://cdn-icons-png.flaticon.com/512/190/190.411.png" // Ï≤¥ÌÅ¨ ÏïÑÏù¥ÏΩò
            });
        } else if (Notification.permission !== "denied") {
            // Í∂åÌïúÏù¥ Í≤∞Ï†ïÎêòÏßÄ ÏïäÏïòÎã§Î©¥ ÏöîÏ≤≠
            Notification.requestPermission();
        }
    }
       
        updateStreakBanner();
        updateGreeting();
        initWeather();

        // [Day 11] ÏãúÏûë Ïãú ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠
        if ("Notification" in window && Notification.permission !== "granted") {
            Notification.requestPermission();
        }   
        // --- Day 9: Sound & Haptic Engine ---

// 1. Í∏∞Î∂Ñ Ï¢ãÏùÄ 'ÌÜ°' ÏÜåÎ¶¨ ÏÉùÏÑ± Ìï®Ïàò (Web Audio API ÏÇ¨Ïö©)
        function playTapSound() {
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(800, audioCtx.currentTime); // Ï£ºÌååÏàò (ÎÜíÎÇÆÏù¥)
            oscillator.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);

            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);
        } catch (e) {
            console.log("Audio play failed:", e);
        }
    }

// 2. ÏÑ±Í≥µ Ïãú 'Îî©Îèô' ÏÜåÎ¶¨
        function playSuccessSound() {
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const notes = [523.25, 659.25, 783.99]; // C5, E5, G5 ÏΩîÎìú
        
            notes.forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime + i * 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime + i * 0.1);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i * 0.1 + 0.3);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(audioCtx.currentTime + i * 0.1);
                osc.stop(audioCtx.currentTime + i * 0.1 + 0.3);
            });
        } catch (e) { }
    }

// 3. ÏßÑÎèô Ìï®Ïàò (Haptic)
        function triggerHaptic(type = 'light') {
        if ("vibrate" in navigator) {
        if (type === 'light') navigator.vibrate(10);      // ÏßßÍ≤å ÌÜ°
        else if (type === 'medium') navigator.vibrate(30); // Ï§ëÍ∞Ñ
        else if (type === 'success') navigator.vibrate([30, 50, 30]); // Îî∞Îã•!
        }
    }

// ÌÜµÌï© ÌîºÎìúÎ∞± Ìï®Ïàò
        function feedback(type = 'tap') {
            if (type === 'tap') {
                playTapSound();
                triggerHaptic('light');
            } else if (type === 'success') {
                playSuccessSound();
                triggerHaptic('success');
            }
        }



// ÏãúÏûëÌï† Îïå: Í≤ΩÏæåÌïòÍ≤å Ïò¨ÎùºÍ∞ÄÎäî ÏÜåÎ¶¨
        function playStartSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.2); // Ï£ºÌååÏàò ÏÉÅÏäπ
                
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.2);
                triggerHaptic('medium'); // ÏïΩÍ∞Ñ Îçî Î¨µÏßÅÌïú ÏßÑÎèô
            } catch (e) {}
        }

// ÎÅùÎÇ¨ÏùÑ Îïå: Î™ÖÎûëÌïú "Îù†ÎßÅ!" ÏÜåÎ¶¨ (Îëê Î≤à Î∞òÎ≥µ)
        function playTimerEndSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                [660, 880].forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.frequency.setValueAtTime(freq, audioCtx.currentTime + i * 0.15);
                    gain.gain.setValueAtTime(0.1, audioCtx.currentTime + i * 0.15);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i * 0.15 + 0.3);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start(audioCtx.currentTime + i * 0.15);
                    osc.stop(audioCtx.currentTime + i * 0.15 + 0.3);
                });
                triggerHaptic('success');
            } catch (e) {}
        }

        // ÏïÑÏ£º ÏßßÍ≥† Í±¥Ï°∞Ìïú 'Ìã±' ÏÜåÎ¶¨ (ÎÇòÎ¨¥Î•º ÏπòÎäî ÎìØÌïú ÎäêÎÇå)
        function playTickSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();

                osc.type = 'square'; // ÏïΩÍ∞Ñ ÌÉÅÌïú ÏÜåÎ¶¨Î•º ÏúÑÌï¥ square ÌÉÄÏûÖ ÏÇ¨Ïö©
                osc.frequency.setValueAtTime(150, audioCtx.currentTime); // ÎÇÆÏùÄ Ï£ºÌååÏàò

                gain.gain.setValueAtTime(0.02, audioCtx.currentTime); // ÏïÑÏ£º ÏûëÍ≤å ÏÑ§Ï†ï
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);

                osc.connect(gain);
                gain.connect(audioCtx.destination);

                osc.start();
                osc.stop(audioCtx.currentTime + 0.05);
                
                // ÏãúÍ∞ÅÏ†Å ÏßëÏ§ëÏùÑ ÏúÑÌï¥ ÏïÑÏ£º ÏïΩÌïú ÏßÑÎèô Î≥ëÌñâ (ÏÑ†ÌÉù ÏÇ¨Ìï≠)
                // triggerHaptic('light'); 
            } catch (e) {}
        }
        
        // Day 12: Service Worker Îì±Î°ù Î°úÏßÅ
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        // ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Îì±Î°ùÎê®
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, function(err) {
                        // Îì±Î°ù Ïã§Ìå®
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }


        async function saveToBackend(entry) {
            try {
                const response = await fetch(`${API_BASE_URL}/emotions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entry)
                });
                if (!response.ok) throw new Error('Network response was not ok');
                console.log("Synced to MacBook DB! ‚úÖ");
            } catch (error) {
                console.error("Failed to sync. Keeping local only. ‚ö†Ô∏è", error);
            }
        }

    </script>

</body>
</html>
